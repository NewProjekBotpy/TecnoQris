"use strict";var Be=Object.create;var ue=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var qe=Object.getPrototypeOf,Ve=Object.prototype.hasOwnProperty;var Q=(s,e)=>()=>(s&&(e=s(s=0)),e);var $=(s,e)=>{for(var t in e)ue(s,t,{get:e[t],enumerable:!0})},ze=(s,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Oe(e))!Ve.call(s,r)&&r!==t&&ue(s,r,{get:()=>e[r],enumerable:!(a=We(e,r))||a.enumerable});return s};var L=(s,e,t)=>(t=s!=null?Be(qe(s)):{},ze(e||!s||!s.__esModule?ue(t,"default",{value:s,enumerable:!0}):t,s));var X={};$(X,{apiKeys:()=>I,insertApiKeySchema:()=>He,insertPaymentChannelSchema:()=>st,insertPaymentSchema:()=>Ge,insertQrCodeSchema:()=>G,insertTransactionSchema:()=>H,insertUserSchema:()=>ce,insertWalletSchema:()=>Y,insertWebhookLogSchema:()=>Ze,paymentChannels:()=>k,payments:()=>b,qrCodes:()=>S,selectApiKeySchema:()=>Ye,selectPaymentChannelSchema:()=>rt,selectPaymentSchema:()=>Je,selectQrCodeSchema:()=>$e,selectTransactionSchema:()=>Fe,selectUserSchema:()=>Me,selectWalletSchema:()=>Qe,selectWebhookLogSchema:()=>tt,transactions:()=>_,updatePaymentChannelSchema:()=>at,updatePaymentSchema:()=>Xe,updateWebhookLogSchema:()=>et,users:()=>x,wallets:()=>v,webhookLogs:()=>T});var n,A,x,_,v,S,I,b,T,k,ce,Me,H,Fe,Y,Qe,G,$e,He,Ye,Ge,Xe,Je,Ze,et,tt,st,at,rt,J=Q(()=>{"use strict";n=require("drizzle-orm/pg-core"),A=require("drizzle-zod"),x=(0,n.pgTable)("users",{id:(0,n.uuid)("id").defaultRandom().primaryKey(),username:(0,n.text)("username").notNull().unique(),password:(0,n.text)("password").notNull(),name:(0,n.text)("name").notNull(),email:(0,n.text)("email").notNull(),role:(0,n.text)("role").notNull().default("Merchant"),balance:(0,n.real)("balance").notNull().default(0),avatar:(0,n.text)("avatar")}),_=(0,n.pgTable)("transactions",{id:(0,n.uuid)("id").defaultRandom().primaryKey(),userId:(0,n.uuid)("user_id").notNull().references(()=>x.id),transactionId:(0,n.text)("transaction_id").notNull(),type:(0,n.text)("type").notNull(),amount:(0,n.real)("amount").notNull(),status:(0,n.text)("status").notNull().default("pending"),customer:(0,n.text)("customer").notNull(),method:(0,n.text)("method").notNull(),createdAt:(0,n.timestamp)("created_at",{withTimezone:!0}).notNull().defaultNow()}),v=(0,n.pgTable)("wallets",{id:(0,n.uuid)("id").defaultRandom().primaryKey(),userId:(0,n.uuid)("user_id").notNull().references(()=>x.id),name:(0,n.text)("name").notNull(),type:(0,n.text)("type").notNull(),accountNumber:(0,n.text)("account_number"),bankName:(0,n.text)("bank_name"),isDefault:(0,n.boolean)("is_default").notNull().default(!1),balance:(0,n.real)("balance").notNull().default(0),createdAt:(0,n.timestamp)("created_at",{withTimezone:!0}).notNull().defaultNow()}),S=(0,n.pgTable)("qr_codes",{id:(0,n.uuid)("id").defaultRandom().primaryKey(),userId:(0,n.uuid)("user_id").notNull().references(()=>x.id),name:(0,n.text)("name").notNull(),amount:(0,n.real)("amount"),description:(0,n.text)("description"),qrData:(0,n.text)("qr_data").notNull(),isActive:(0,n.boolean)("is_active").notNull().default(!0),createdAt:(0,n.timestamp)("created_at",{withTimezone:!0}).notNull().defaultNow()}),I=(0,n.pgTable)("api_keys",{id:(0,n.uuid)("id").defaultRandom().primaryKey(),userId:(0,n.uuid)("user_id").notNull().references(()=>x.id),name:(0,n.text)("name").notNull(),key:(0,n.text)("key").notNull().unique(),mode:(0,n.text)("mode").notNull().default("live"),isActive:(0,n.boolean)("is_active").notNull().default(!0),createdAt:(0,n.timestamp)("created_at",{withTimezone:!0}).notNull().defaultNow(),lastUsed:(0,n.timestamp)("last_used",{withTimezone:!0}),requestCount:(0,n.integer)("request_count").notNull().default(0)}),b=(0,n.pgTable)("payments",{id:(0,n.uuid)("id").defaultRandom().primaryKey(),userId:(0,n.uuid)("user_id").notNull().references(()=>x.id),externalId:(0,n.text)("external_id").notNull(),amount:(0,n.real)("amount").notNull(),description:(0,n.text)("description"),customerName:(0,n.text)("customer_name"),customerEmail:(0,n.text)("customer_email"),customerPhone:(0,n.text)("customer_phone"),status:(0,n.text)("status").notNull().default("pending"),qrString:(0,n.text)("qr_string").notNull(),qrUrl:(0,n.text)("qr_url"),expiresAt:(0,n.timestamp)("expires_at",{withTimezone:!0}).notNull(),paidAt:(0,n.timestamp)("paid_at",{withTimezone:!0}),createdAt:(0,n.timestamp)("created_at",{withTimezone:!0}).notNull().defaultNow(),paymentMethod:(0,n.text)("payment_method").notNull(),providerRef:(0,n.text)("provider_ref"),providerStatus:(0,n.text)("provider_status"),signatureHash:(0,n.text)("signature_hash"),idempotencyKey:(0,n.text)("idempotency_key").unique(),callbackUrl:(0,n.text)("callback_url"),feeAmount:(0,n.real)("fee_amount").notNull().default(0),netAmount:(0,n.real)("net_amount")}),T=(0,n.pgTable)("webhook_logs",{id:(0,n.uuid)("id").defaultRandom().primaryKey(),paymentId:(0,n.uuid)("payment_id").notNull().references(()=>b.id),eventType:(0,n.text)("event_type").notNull(),payload:(0,n.text)("payload").notNull(),signature:(0,n.text)("signature").notNull(),verified:(0,n.boolean)("verified").notNull().default(!1),processedAt:(0,n.timestamp)("processed_at",{withTimezone:!0}),createdAt:(0,n.timestamp)("created_at",{withTimezone:!0}).notNull().defaultNow()}),k=(0,n.pgTable)("payment_channels",{id:(0,n.uuid)("id").defaultRandom().primaryKey(),code:(0,n.text)("code").notNull().unique(),name:(0,n.text)("name").notNull(),type:(0,n.text)("type").notNull(),isActive:(0,n.boolean)("is_active").notNull().default(!0),feePercentage:(0,n.real)("fee_percentage").notNull().default(0),feeFlat:(0,n.real)("fee_flat").notNull().default(0),minAmount:(0,n.real)("min_amount").notNull().default(1e3),maxAmount:(0,n.real)("max_amount").notNull().default(1e8),iconUrl:(0,n.text)("icon_url")}),ce=(0,A.createInsertSchema)(x).omit({id:!0}),Me=(0,A.createSelectSchema)(x),H=(0,A.createInsertSchema)(_).omit({id:!0}),Fe=(0,A.createSelectSchema)(_),Y=(0,A.createInsertSchema)(v).omit({id:!0}),Qe=(0,A.createSelectSchema)(v),G=(0,A.createInsertSchema)(S).omit({id:!0}),$e=(0,A.createSelectSchema)(S),He=(0,A.createInsertSchema)(I).omit({id:!0,lastUsed:!0,requestCount:!0}),Ye=(0,A.createSelectSchema)(I),Ge=(0,A.createInsertSchema)(b).omit({id:!0,paidAt:!0,createdAt:!0}),Xe=(0,A.createInsertSchema)(b).omit({id:!0,createdAt:!0}).partial(),Je=(0,A.createSelectSchema)(b),Ze=(0,A.createInsertSchema)(T).omit({id:!0,processedAt:!0}),et=(0,A.createInsertSchema)(T).omit({id:!0,createdAt:!0}).partial(),tt=(0,A.createSelectSchema)(T),st=(0,A.createInsertSchema)(k).omit({id:!0}),at=(0,A.createInsertSchema)(k).omit({id:!0}).partial(),rt=(0,A.createSelectSchema)(k)});var be={};$(be,{db:()=>d,getDb:()=>dt,getInitializationError:()=>ut,getPool:()=>lt,initializeDatabase:()=>ct,isDatabaseConfigured:()=>it,pool:()=>mt});function it(){return!!process.env.DATABASE_URL}function ut(){return B}async function ct(){if(de&&U)return{success:!0,pool:D,db:U};if(B)return{success:!1,error:B.message};let s=process.env.DATABASE_URL;if(!s)return B=new Error("DATABASE_URL must be set. Please configure the DATABASE_URL environment variable in Vercel."),console.error("[DB] DATABASE_URL is not set"),{success:!1,error:B.message};try{let e=s.includes("pgbouncer=true")||s.includes("pooler.supabase.com");if(console.log("[DB] Initializing database...",{isPgBouncer:e,isVercel:Ae,isProduction:ot}),e||Ae){console.log("[DB] Using postgres.js driver with prepare: false for PgBouncer compatibility");let t=(0,we.default)(s,{prepare:!1,max:1,idle_timeout:20,connect_timeout:10,ssl:"require"});console.log("[DB] Testing database connection...");let a=await t`SELECT NOW() as now`;return console.log("[DB] Connection test successful:",a[0]?.now),U=(0,Pe.drizzle)(t,{schema:X}),de=!0,console.log("[DB] Database initialized successfully with postgres.js driver"),{success:!0,db:U}}else{console.log("[DB] Using node-postgres driver for local development");let t={connectionString:s,max:10,idleTimeoutMillis:3e4,connectionTimeoutMillis:1e4,statement_timeout:6e4};(s.includes("neon.tech")||s.includes("supabase"))&&(t.ssl={rejectUnauthorized:!1}),D=new nt(t),D.on("error",r=>{console.error("[DB] Unexpected pool error:",r)}),console.log("[DB] Testing database connection...");let a=await D.connect();try{let r=await a.query("SELECT NOW() as now");console.log("[DB] Connection test successful:",r.rows[0]?.now)}finally{a.release()}return U=(0,Ie.drizzle)(D,{schema:X}),de=!0,console.log("[DB] Database initialized successfully with node-postgres driver"),{success:!0,pool:D,db:U}}}catch(e){return B=e,console.error("[DB] Failed to initialize database:",e?.message),console.error("[DB] Error stack:",e?.stack),{success:!1,error:e?.message}}}function dt(){return U}function lt(){return D}var Ie,Pe,_e,we,nt,ot,Ae,D,U,B,de,mt,d,le=Q(()=>{"use strict";Ie=require("drizzle-orm/node-postgres"),Pe=require("drizzle-orm/postgres-js"),_e=L(require("pg"),1),we=L(require("postgres"),1);J();({Pool:nt}=_e.default),ot=!0,Ae=process.env.VERCEL==="1"||process.env.VERCEL_ENV!==void 0,D=null,U=null,B=null,de=!1;mt=new Proxy({},{get(s,e){if(!D)throw new Error("Database pool not initialized. Call initializeDatabase() first.");return D[e]}}),d=new Proxy({},{get(s,e){if(!U)throw new Error("Database not initialized. Call initializeDatabase() first.");return U[e]}})});var Re={};$(Re,{DrizzleStorage:()=>Z,storage:()=>pt});var me,u,Z,pt,xe=Q(()=>{"use strict";me=L(require("crypto"),1),u=require("drizzle-orm");le();J();Z=class{async getUser(e){return(await d.select().from(x).where((0,u.eq)(x.id,e)).limit(1))[0]}async getUserByUsername(e){return(await d.select().from(x).where((0,u.eq)(x.username,e)).limit(1))[0]}async createUser(e){return(await d.insert(x).values({...e,role:e.role||"Merchant",balance:e.balance||0,avatar:e.avatar||null}).returning())[0]}async updateUser(e,t){return(await d.update(x).set(t).where((0,u.eq)(x.id,e)).returning())[0]}async getTransactions(e,t=100){return d.select().from(_).where((0,u.eq)(_.userId,e)).orderBy((0,u.desc)(_.createdAt)).limit(t)}async getTransactionById(e){return(await d.select().from(_).where((0,u.eq)(_.id,e)).limit(1))[0]}async createTransaction(e){return(await d.insert(_).values({...e,status:e.status||"pending"}).returning())[0]}async createTransactionsBatch(e){let t=e.map(a=>({...a,status:a.status||"pending"}));return d.insert(_).values(t).returning()}async updateTransaction(e,t){return(await d.update(_).set(t).where((0,u.eq)(_.id,e)).returning())[0]}async getWallets(e){return d.select().from(v).where((0,u.eq)(v.userId,e)).orderBy((0,u.desc)(v.createdAt))}async getWalletById(e){return(await d.select().from(v).where((0,u.eq)(v.id,e)).limit(1))[0]}async createWallet(e){return(await d.insert(v).values({...e,isDefault:e.isDefault??!1,balance:e.balance||0}).returning())[0]}async updateWallet(e,t){return(await d.update(v).set(t).where((0,u.eq)(v.id,e)).returning())[0]}async deleteWallet(e){await d.delete(v).where((0,u.eq)(v.id,e))}async getQrCodes(e){return d.select().from(S).where((0,u.eq)(S.userId,e)).orderBy((0,u.desc)(S.createdAt))}async getQrCodeById(e){return(await d.select().from(S).where((0,u.eq)(S.id,e)).limit(1))[0]}async createQrCode(e){return(await d.insert(S).values({...e,isActive:e.isActive??!0}).returning())[0]}async updateQrCode(e,t){return(await d.update(S).set(t).where((0,u.eq)(S.id,e)).returning())[0]}async deleteQrCode(e){await d.delete(S).where((0,u.eq)(S.id,e))}async getApiKeys(e){return d.select().from(I).where((0,u.eq)(I.userId,e)).orderBy((0,u.desc)(I.createdAt))}async getApiKeyByValue(e){return(await d.select().from(I).where((0,u.eq)(I.key,e)).limit(1))[0]}async createOrResetApiKey(e,t,a){await d.delete(I).where((0,u.and)((0,u.eq)(I.userId,e),(0,u.eq)(I.mode,t)));let r=t==="sandbox"?"Sandbox Key":"Live Key";return(await d.insert(I).values({userId:e,name:r,key:a,mode:t,isActive:!0}).returning())[0]}async createInitialApiKeys(e){let t="sk_sandbox_"+me.default.randomBytes(24).toString("hex"),a="sk_live_"+me.default.randomBytes(24).toString("hex");return d.insert(I).values([{userId:e,name:"Sandbox Key",key:t,mode:"sandbox",isActive:!0},{userId:e,name:"Live Key",key:a,mode:"live",isActive:!0}]).returning()}async updateApiKeyStatus(e,t){return(await d.update(I).set({isActive:t}).where((0,u.eq)(I.id,e)).returning())[0]}async updateApiKeyLastUsed(e){await d.update(I).set({lastUsed:new Date}).where((0,u.eq)(I.id,e))}async incrementApiKeyUsage(e){await d.update(I).set({lastUsed:new Date,requestCount:u.sql`${I.requestCount} + 1`}).where((0,u.eq)(I.id,e))}async getPayments(e,t=100){return d.select().from(b).where((0,u.eq)(b.userId,e)).orderBy((0,u.desc)(b.createdAt)).limit(t)}async getPaymentById(e){return(await d.select().from(b).where((0,u.eq)(b.id,e)).limit(1))[0]}async getPaymentByExternalId(e){return(await d.select().from(b).where((0,u.eq)(b.externalId,e)).limit(1))[0]}async getPaymentByIdempotencyKey(e){return(await d.select().from(b).where((0,u.eq)(b.idempotencyKey,e)).limit(1))[0]}async createPayment(e){return(await d.insert(b).values({...e,status:e.status||"pending"}).returning())[0]}async updatePayment(e,t){return(await d.update(b).set(t).where((0,u.eq)(b.id,e)).returning())[0]}async getWebhookLogs(e){return d.select().from(T).where((0,u.eq)(T.paymentId,e)).orderBy((0,u.desc)(T.createdAt))}async createWebhookLog(e){return(await d.insert(T).values(e).returning())[0]}async updateWebhookLog(e,t){return(await d.update(T).set(t).where((0,u.eq)(T.id,e)).returning())[0]}async getPaymentChannels(){return d.select().from(k).orderBy(k.code)}async getPaymentChannelByCode(e){return(await d.select().from(k).where((0,u.eq)(k.code,e)).limit(1))[0]}async createPaymentChannel(e){return(await d.insert(k).values({...e,isActive:e.isActive??!0,feePercentage:e.feePercentage??0,feeFlat:e.feeFlat??0,minAmount:e.minAmount??1e3,maxAmount:e.maxAmount??1e8,iconUrl:e.iconUrl||null}).returning())[0]}async updatePaymentChannel(e,t){return(await d.update(k).set(t).where((0,u.eq)(k.id,e)).returning())[0]}async seedPaymentChannels(){let e=[{code:"QRIS",name:"QRIS Payment",type:"qris",isActive:!0,feePercentage:.7,feeFlat:0,minAmount:1e3,maxAmount:1e7},{code:"BCAVA",name:"BCA Virtual Account",type:"va",isActive:!0,feePercentage:0,feeFlat:4e3,minAmount:1e4,maxAmount:1e8},{code:"BRIVA",name:"BRI Virtual Account",type:"va",isActive:!0,feePercentage:0,feeFlat:4e3,minAmount:1e4,maxAmount:1e8},{code:"BNIVA",name:"BNI Virtual Account",type:"va",isActive:!0,feePercentage:0,feeFlat:4e3,minAmount:1e4,maxAmount:1e8},{code:"GOPAY",name:"GoPay",type:"ewallet",isActive:!0,feePercentage:2,feeFlat:0,minAmount:1e3,maxAmount:1e7},{code:"DANA",name:"DANA",type:"ewallet",isActive:!0,feePercentage:1.5,feeFlat:0,minAmount:1e3,maxAmount:1e7},{code:"OVO",name:"OVO",type:"ewallet",isActive:!0,feePercentage:2,feeFlat:0,minAmount:1e3,maxAmount:1e7}];for(let t of e)await this.getPaymentChannelByCode(t.code)||await this.createPaymentChannel(t)}async getRevenueStats(e,t,a){let r=[(0,u.eq)(_.userId,e)];t&&r.push((0,u.gte)(_.createdAt,t)),a&&r.push((0,u.lte)(_.createdAt,a));let o=await d.select().from(_).where((0,u.and)(...r)),c=0,g=0,p=0,m=0;for(let y of o)c+=y.amount,y.status==="success"?g+=y.amount:y.status==="pending"?p+=y.amount:y.status==="failed"&&(m+=y.amount);return{total:c,success:g,pending:p,failed:m}}async getTransactionStats(e){let t=await d.select().from(_).where((0,u.eq)(_.userId,e)),a=0,r=0,o=0,c=0;for(let g of t)a++,g.status==="success"?r++:g.status==="pending"?o++:g.status==="failed"&&c++;return{total:a,success:r,pending:o,failed:c}}},pt=new Z});var Se={};$(Se,{SakurupiahApiError:()=>O,SakurupiahConfigError:()=>W,SakurupiahError:()=>E,SakurupiahNetworkError:()=>te,SakurupiahService:()=>ae,SakurupiahSignatureError:()=>ge,SakurupiahTimeoutError:()=>se,default:()=>yt,getSakurupiahService:()=>ve,resetSakurupiahService:()=>gt});function ve(){return ee||(ee=new ae),ee}function gt(){ee=null}var pe,E,W,te,se,O,ge,ye,ae,ee,yt,Ee=Q(()=>{"use strict";pe=require("crypto"),E=class extends Error{constructor(t,a,r,o){super(t);this.code=a;this.statusCode=r;this.response=o;this.name="SakurupiahError"}},W=class extends E{constructor(e){super(e,"CONFIG_ERROR"),this.name="SakurupiahConfigError"}},te=class extends E{constructor(t,a){super(t,"NETWORK_ERROR");this.originalError=a;this.name="SakurupiahNetworkError"}},se=class extends E{constructor(e="Request timed out"){super(e,"TIMEOUT_ERROR"),this.name="SakurupiahTimeoutError"}},O=class extends E{constructor(e,t,a){super(e,"API_ERROR",t,a),this.name="SakurupiahApiError"}},ge=class extends E{constructor(e="Invalid webhook signature"){super(e,"SIGNATURE_ERROR"),this.name="SakurupiahSignatureError"}},ye=class{prefix="[Sakurupiah]";formatLog(e,t,a){return{timestamp:new Date().toISOString(),level:e,message:`${this.prefix} ${t}`,data:a}}info(e,t){let a=this.formatLog("info",e,t);console.log(a.timestamp,a.message,t?JSON.stringify(t):"")}warn(e,t){let a=this.formatLog("warn",e,t);console.warn(a.timestamp,a.message,t?JSON.stringify(t):"")}error(e,t){let a=this.formatLog("error",e,t);console.error(a.timestamp,a.message,t?JSON.stringify(t):"")}debug(e,t){if(process.env.SAKURUPIAH_DEBUG==="true"){let a=this.formatLog("debug",e,t);console.debug(a.timestamp,a.message,t?JSON.stringify(t):"")}}},ae=class{config;logger;MAX_RETRIES=3;REQUEST_TIMEOUT=3e4;RETRY_BASE_DELAY=1e3;constructor(){this.logger=new ye,this.config=this.loadConfig(),this.logger.info("Service initialized",{mode:this.config.mode,baseUrl:this.config.baseUrl})}loadConfig(){let e=process.env.SAKURUPIAH_API_ID,t=process.env.SAKURUPIAH_API_KEY,a=process.env.SAKURUPIAH_MODE||"sandbox";if(!e)throw new W("SAKURUPIAH_API_ID environment variable is required");if(!t)throw new W("SAKURUPIAH_API_KEY environment variable is required");if(a!=="sandbox"&&a!=="production")throw new W('SAKURUPIAH_MODE must be either "sandbox" or "production"');return{apiId:e,apiKey:t,mode:a,baseUrl:a==="production"?"https://sakurupiah.id/api/":"https://sakurupiah.id/api-sanbox/"}}getConfig(){return{apiId:this.config.apiId,mode:this.config.mode,baseUrl:this.config.baseUrl}}generateSignature(e,t,a){let r=`${this.config.apiId}${e}${t}${a}`,o=(0,pe.createHmac)("sha256",this.config.apiKey).update(r).digest("hex");return this.logger.debug("Generated signature",{method:e,merchantRef:t,amount:a,signaturePreview:o.substring(0,16)+"..."}),o}verifyWebhookSignature(e,t){if(!e||!t)return this.logger.warn("Missing payload or signature for verification"),!1;try{let a=(0,pe.createHmac)("sha256",this.config.apiKey).update(e).digest("hex"),r=a===t;return this.logger.debug("Webhook signature verification",{isValid:r,receivedSignaturePreview:t.substring(0,16)+"...",expectedSignaturePreview:a.substring(0,16)+"..."}),r}catch(a){return this.logger.error("Error verifying webhook signature",{error:a}),!1}}async sleep(e){return new Promise(t=>setTimeout(t,e))}async makeRequest(e,t){let a=`${this.config.baseUrl}${e}`,r=`req_${Date.now()}_${Math.random().toString(36).substring(7)}`,o=null;for(let c=1;c<=this.MAX_RETRIES;c++){let g=new AbortController,p=setTimeout(()=>g.abort(),this.REQUEST_TIMEOUT);try{this.logger.info(`Request attempt ${c}/${this.MAX_RETRIES}`,{requestId:r,endpoint:e,attempt:c}),this.logger.debug("Request details",{requestId:r,url:a,body:{...t,signature:t.signature?"[REDACTED]":void 0}});let m=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","User-Agent":"SakurupiahService/1.0"},body:JSON.stringify(t),signal:g.signal});clearTimeout(p);let y=await m.json();if(this.logger.debug("Response received",{requestId:r,status:m.status,data:y}),!m.ok)throw new O(y.message||`HTTP ${m.status}: ${m.statusText}`,m.status,y);if(y.status==="error"||y.status==="failed")throw new O(y.message||"API returned error status",m.status,y);return this.logger.info("Request successful",{requestId:r,endpoint:e,attempt:c}),y}catch(m){if(clearTimeout(p),o=m,m instanceof O&&m.statusCode&&m.statusCode>=400&&m.statusCode<500)throw this.logger.error("Client error - not retrying",{requestId:r,error:m.message,statusCode:m.statusCode}),m;if(m.name==="AbortError"&&(o=new se(`Request timed out after ${this.REQUEST_TIMEOUT}ms`)),c<this.MAX_RETRIES){let y=this.RETRY_BASE_DELAY*Math.pow(2,c-1);this.logger.warn(`Request failed, retrying in ${y}ms`,{requestId:r,attempt:c,error:o.message,nextRetryIn:y}),await this.sleep(y)}}}throw this.logger.error("All retry attempts exhausted",{requestId:r,endpoint:e,error:o?.message}),o instanceof E?o:new te(`Request failed after ${this.MAX_RETRIES} attempts: ${o?.message}`,o)}async listPaymentChannels(){this.logger.info("Fetching payment channels");let e={api_id:this.config.apiId};try{let t=await this.makeRequest("payment-channels",e);return this.logger.info("Payment channels fetched",{count:t.data?.length||0}),t}catch(t){throw this.logger.error("Failed to fetch payment channels",{error:t}),t}}async createTransaction(e){if(this.logger.info("Creating transaction",{method:e.method,merchantRef:e.merchant_ref,amount:e.amount}),!e.method)throw new E("Payment method is required","VALIDATION_ERROR");if(!e.merchant_ref)throw new E("Merchant reference is required","VALIDATION_ERROR");if(!e.amount||e.amount<=0)throw new E("Valid amount is required","VALIDATION_ERROR");let t=this.generateSignature(e.method,e.merchant_ref,e.amount),a={api_id:this.config.apiId,method:e.method,merchant_ref:e.merchant_ref,amount:e.amount,signature:t};e.customer_name&&(a.customer_name=e.customer_name),e.customer_email&&(a.customer_email=e.customer_email),e.customer_phone&&(a.customer_phone=e.customer_phone),e.callback_url&&(a.callback_url=e.callback_url),e.return_url&&(a.return_url=e.return_url),e.expired_time&&(a.expired_time=e.expired_time);try{let r=await this.makeRequest("create-transaction",a);return this.logger.info("Transaction created successfully",{reference:r.data?.reference,merchantRef:r.data?.merchant_ref,amount:r.data?.amount,total:r.data?.total}),r}catch(r){throw this.logger.error("Failed to create transaction",{merchantRef:e.merchant_ref,error:r}),r}}async checkTransactionStatus(e){if(this.logger.info("Checking transaction status",{reference:e}),!e)throw new E("Transaction reference is required","VALIDATION_ERROR");let t={api_id:this.config.apiId,reference:e};try{let a=await this.makeRequest("check-status",t);return this.logger.info("Transaction status retrieved",{reference:a.data?.reference,status:a.data?.status}),a}catch(a){throw this.logger.error("Failed to check transaction status",{reference:e,error:a}),a}}parseWebhookPayload(e){try{return JSON.parse(e)}catch{throw new E("Failed to parse webhook payload","PARSE_ERROR")}}validateAndParseWebhook(e,t){if(!this.verifyWebhookSignature(e,t))return this.logger.warn("Invalid webhook signature received"),{isValid:!1,data:null};try{let r=this.parseWebhookPayload(e);return this.logger.info("Webhook validated and parsed",{reference:r.reference,status:r.status}),{isValid:!0,data:r}}catch(r){return this.logger.error("Failed to parse webhook payload after validation",{error:r}),{isValid:!1,data:null}}}},ee=null;yt=ve});var ne=L(require("express"),1),Ne=L(require("serverless-http"),1),De=L(require("crypto"),1),oe=require("jose");J();var h=require("zod"),re=null,q=null,i=null,j=null,C=!1,ke=!1;function M(){return!!process.env.DATABASE_URL}async function Ue(){return re||(re=await import("bcryptjs")),re.default||re}async function K(){if(ke&&i!==null)return!0;if(!M())return console.error("[Init] DATABASE_URL not configured"),!1;q||(q=await Promise.resolve().then(()=>(le(),be)));let s=await q.initializeDatabase();if(!s.success)return console.error("[Init] Failed to initialize database:",s.error),!1;try{i=(await Promise.resolve().then(()=>(xe(),Re))).storage,console.log("[Init] Database and storage initialized successfully")}catch(e){return console.error("[Init] Failed to initialize storage:",e?.message),!1}try{j=(await Promise.resolve().then(()=>(Ee(),Se))).getSakurupiahService(),C=!0,console.log("[Payment] Sakurupiah service initialized successfully")}catch(e){e?.message?.includes("SAKURUPIAH")?console.warn("[Payment] Sakurupiah not configured - running in sandbox mode"):console.error("[Payment] Failed to initialize Sakurupiah service:",e?.message),C=!1}return ke=!0,!0}function ie(s,e,t){if(!M())return e.status(503).json({message:"Database not configured",error:"DATABASE_URL environment variable is not set. Please configure it in Vercel dashboard under Settings > Environment Variables.",code:"DATABASE_NOT_CONFIGURED"});if(q){let a=q.getInitializationError?.();if(a)return e.status(503).json({message:"Database initialization failed",error:a.message,code:"DATABASE_INIT_FAILED"})}if(!i)return e.status(503).json({message:"Service not ready",error:"Database connection is being established. Please try again in a moment.",code:"SERVICE_NOT_READY"});t()}var l=(0,ne.default)(),je=new TextEncoder().encode(process.env.SESSION_SECRET||"fintech-dashboard-secret-key-2024");l.set("trust proxy",1);l.use(ne.default.json());l.use(ne.default.urlencoded({extended:!1}));l.get("/api/ping",(s,e)=>{e.json({status:"ok",timestamp:Date.now()})});async function Le(s){return await new oe.SignJWT({userId:s}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("24h").sign(je)}async function ft(s){try{let{payload:e}=await(0,oe.jwtVerify)(s,je);return typeof e.userId=="string"?{userId:e.userId,iat:e.iat,exp:e.exp}:null}catch{return null}}function ht(s){let e=s.headers.authorization;if(e&&e.startsWith("Bearer "))return e.slice(7);let t=s.headers.cookie;if(t){let r=t.split(";").map(o=>o.trim()).find(o=>o.startsWith("auth_token="));if(r)return r.split("=")[1]}return null}async function P(s,e,t){if(await K(),!M()||!i)return e.status(503).json({message:"Service unavailable",error:"Database not configured. Please check DATABASE_URL in Vercel environment variables.",code:"DATABASE_NOT_CONFIGURED"});let a=ht(s);if(!a)return e.status(401).json({message:"Unauthorized"});let r=await ft(a);if(!r||!r.userId)return e.status(401).json({message:"Invalid or expired token"});s.userId=r.userId,t()}async function F(s,e,t){if(await K(),!M()||!i)return e.status(503).json({success:!1,error:{code:"DATABASE_NOT_CONFIGURED",message:"Database not configured. Please check DATABASE_URL in Vercel environment variables."}});let a=s.headers["x-api-key"];if(!a)return e.status(401).json({success:!1,error:{code:"MISSING_API_KEY",message:"API key is required. Please provide X-API-Key header."}});try{let r=await i.getApiKeyByValue(a);if(!r)return e.status(401).json({success:!1,error:{code:"INVALID_API_KEY",message:"Invalid API key. Please check your API key and try again."}});if(!r.isActive)return e.status(403).json({success:!1,error:{code:"INACTIVE_API_KEY",message:"This API key has been deactivated."}});await i.incrementApiKeyUsage(r.id),s.apiKey=r,s.apiKeyUserId=r.userId,t()}catch(r){return console.error("API key auth error:",r?.message||r),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}}function Ce(s,e,t="QRIS Merchant"){let a=Date.now().toString(36);return`00020101021226580016ID.CO.QRIS.WWW0215ID${s.slice(0,15)}0303UMI51440014ID.CO.QRIS.WWW0215ID${a}53033605802ID5913${t.slice(0,13)}6007Jakarta61051234062070703A01${e.toString().padStart(13,"0")}6304`}var Te=new Map;function fe(s){return(e,t,a)=>{let r=e.headers["x-api-key"],o=e.ip||e.socket.remoteAddress||"unknown",c=`${s.keyPrefix||"default"}:${r||o}`,g=Date.now(),p=Te.get(c);if((!p||p.resetAt<g)&&(p={count:0,resetAt:g+s.windowMs},Te.set(c,p)),p.count++,t.setHeader("X-RateLimit-Limit",s.maxRequests),t.setHeader("X-RateLimit-Remaining",Math.max(0,s.maxRequests-p.count)),t.setHeader("X-RateLimit-Reset",p.resetAt),p.count>s.maxRequests)return t.status(429).json({success:!1,error:{code:"RATE_LIMIT_EXCEEDED",message:"Too many requests. Please try again later.",retry_after:Math.ceil((p.resetAt-g)/1e3)}});a()}}var he=fe({windowMs:60*1e3,maxRequests:10,keyPrefix:"auth"}),V=fe({windowMs:60*1e3,maxRequests:100,keyPrefix:"api_v1"}),At=fe({windowMs:60*1e3,maxRequests:1e3,keyPrefix:"webhook"});l.get("/api/health",async(s,e)=>{await K();let t=C?"configured":"not_configured",a=M(),r=q?.getInitializationError?.()||null,o="unknown";if(!a)o="not_configured: DATABASE_URL not set";else if(r)o=`error: ${r.message}`;else if(i)try{await i.getPaymentChannels(),o="connected"}catch(c){o=`error: ${c.message}`}else o="initializing";e.json({status:a&&i?"ok":"degraded",timestamp:new Date().toISOString(),environment:"production",vercel:process.env.VERCEL==="1"||!!process.env.VERCEL_ENV,services:{postgresql:{configured:a,connection:o,error:a?r?.message||null:"DATABASE_URL not set"},sakurupiah:t},env_check:{DATABASE_URL:process.env.DATABASE_URL?"set":"missing",SESSION_SECRET:process.env.SESSION_SECRET?"set":"missing",SAKURUPIAH_API_ID:process.env.SAKURUPIAH_API_ID?"set":"missing",SAKURUPIAH_API_KEY:process.env.SAKURUPIAH_API_KEY?"set":"missing"}})});l.post("/api/auth/register",he,ie,async(s,e)=>{try{await K();let t=ce.parse(s.body);if(await i.getUserByUsername(t.username))return e.status(400).json({message:"Username already exists"});let o=await(await Ue()).hash(t.password,10),c=await i.createUser({...t,password:o}),g=await Le(c.id);e.setHeader("Set-Cookie",`auth_token=${g}; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=86400`);let{password:p,...m}=c;e.status(201).json({...m,token:g})}catch(t){if(console.error("Registration error:",t?.message||t),console.error("Registration error stack:",t?.stack),t instanceof h.z.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});if(t?.message?.includes("DATABASE_URL")||t?.message?.includes("database")||t?.code==="ECONNREFUSED")return e.status(503).json({message:"Database connection error",error:"Unable to connect to database. Please check DATABASE_URL environment variable in Vercel.",code:"DATABASE_CONNECTION_ERROR"});e.status(500).json({message:"Internal server error",error:void 0,code:"INTERNAL_ERROR"})}});l.post("/api/auth/login",he,ie,async(s,e)=>{try{await K();let{username:t,password:a}=s.body;if(!t||!a)return e.status(400).json({message:"Username and password are required"});let r=await i.getUserByUsername(t);if(!r)return e.status(401).json({message:"Invalid credentials"});if(!await(await Ue()).compare(a,r.password))return e.status(401).json({message:"Invalid credentials"});let g=await Le(r.id);e.setHeader("Set-Cookie",`auth_token=${g}; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=86400`);let{password:p,...m}=r;e.json({...m,token:g})}catch(t){if(console.error("Login error:",t?.message||t),t?.message?.includes("DATABASE_URL")||t?.message?.includes("database")||t?.code==="ECONNREFUSED")return e.status(503).json({message:"Database connection error",error:"Unable to connect to database. Please check DATABASE_URL environment variable in Vercel.",code:"DATABASE_CONNECTION_ERROR"});e.status(500).json({message:"Internal server error",code:"INTERNAL_ERROR"})}});l.post("/api/auth/logout",he,(s,e)=>{e.setHeader("Set-Cookie","auth_token=; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=0"),e.json({message:"Logged out successfully"})});l.get("/api/auth/me",P,async(s,e)=>{try{let t=await i.getUser(s.userId);if(!t)return e.status(404).json({message:"User not found"});let{password:a,...r}=t;e.json(r)}catch{e.status(500).json({message:"Internal server error"})}});l.get("/api/transactions",P,async(s,e)=>{try{let t=s.query.limit?parseInt(s.query.limit):100,a=await i.getTransactions(s.userId,t);e.json(a)}catch{e.status(500).json({message:"Internal server error"})}});l.get("/api/transactions/:id",P,async(s,e)=>{try{let t=await i.getTransactionById(s.params.id);if(!t)return e.status(404).json({message:"Transaction not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});l.post("/api/transactions",P,async(s,e)=>{try{let t=H.parse({...s.body,userId:s.userId}),a=await i.createTransaction(t);e.status(201).json(a)}catch(t){if(t instanceof h.z.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});l.put("/api/transactions/:id",P,async(s,e)=>{try{let t=await i.getTransactionById(s.params.id);if(!t)return e.status(404).json({message:"Transaction not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});let a=H.partial().parse(s.body),r=await i.updateTransaction(s.params.id,a);e.json(r)}catch(t){if(t instanceof h.z.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});l.get("/api/wallets",P,async(s,e)=>{try{let t=await i.getWallets(s.userId);e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});l.get("/api/wallets/:id",P,async(s,e)=>{try{let t=await i.getWalletById(s.params.id);if(!t)return e.status(404).json({message:"Wallet not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});l.post("/api/wallets",P,async(s,e)=>{try{let t=Y.parse({...s.body,userId:s.userId}),a=await i.createWallet(t);e.status(201).json(a)}catch(t){if(t instanceof h.z.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});l.put("/api/wallets/:id",P,async(s,e)=>{try{let t=await i.getWalletById(s.params.id);if(!t)return e.status(404).json({message:"Wallet not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});let a=Y.partial().parse(s.body),r=await i.updateWallet(s.params.id,a);e.json(r)}catch(t){if(t instanceof h.z.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});l.delete("/api/wallets/:id",P,async(s,e)=>{try{let t=await i.getWalletById(s.params.id);if(!t)return e.status(404).json({message:"Wallet not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});await i.deleteWallet(s.params.id),e.status(204).send()}catch{e.status(500).json({message:"Internal server error"})}});l.get("/api/qr-codes",P,async(s,e)=>{try{let t=await i.getQrCodes(s.userId);e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});l.get("/api/qr-codes/:id",P,async(s,e)=>{try{let t=await i.getQrCodeById(s.params.id);if(!t)return e.status(404).json({message:"QR code not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});l.post("/api/qr-codes",P,async(s,e)=>{try{let t=G.parse({...s.body,userId:s.userId}),a=await i.createQrCode(t);e.status(201).json(a)}catch(t){if(t instanceof h.z.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});l.put("/api/qr-codes/:id",P,async(s,e)=>{try{let t=await i.getQrCodeById(s.params.id);if(!t)return e.status(404).json({message:"QR code not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});let a=G.partial().parse(s.body),r=await i.updateQrCode(s.params.id,a);e.json(r)}catch(t){if(t instanceof h.z.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});l.delete("/api/qr-codes/:id",P,async(s,e)=>{try{let t=await i.getQrCodeById(s.params.id);if(!t)return e.status(404).json({message:"QR code not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});await i.deleteQrCode(s.params.id),e.status(204).send()}catch{e.status(500).json({message:"Internal server error"})}});l.get("/api/api-keys",P,async(s,e)=>{try{let t=await i.getApiKeys(s.userId);e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});l.post("/api/api-keys",P,async(s,e)=>{try{let{mode:t}=s.body;if(!t||t!=="sandbox"&&t!=="live")return e.status(400).json({message:"Mode must be 'sandbox' or 'live'"});let r=(t==="sandbox"?"sk_sandbox_":"sk_live_")+De.default.randomBytes(24).toString("hex"),o=await i.createOrResetApiKey(s.userId,t,r);e.status(201).json(o)}catch{e.status(500).json({message:"Internal server error"})}});l.patch("/api/api-keys/:id/status",P,async(s,e)=>{try{if(!(await i.getApiKeys(s.userId)).find(c=>c.id===s.params.id))return e.status(404).json({message:"API key not found"});let{isActive:r}=s.body;if(typeof r!="boolean")return e.status(400).json({message:"isActive must be a boolean"});let o=await i.updateApiKeyStatus(s.params.id,r);e.json(o)}catch{e.status(500).json({message:"Internal server error"})}});l.get("/api/analytics/stats",P,async(s,e)=>{try{let t=await i.getTransactionStats(s.userId);e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});l.get("/api/analytics/revenue",P,async(s,e)=>{try{let t=s.query.startDate?new Date(s.query.startDate):void 0,a=s.query.endDate?new Date(s.query.endDate):void 0,r=await i.getRevenueStats(s.userId,t,a);e.json(r)}catch{e.status(500).json({message:"Internal server error"})}});var It=h.z.object({external_id:h.z.string().min(1).max(100),amount:h.z.number().int().positive().min(1e3).max(1e8),payment_method:h.z.enum(["QRIS","BCAVA","BRIVA","BNIVA","GOPAY","DANA","OVO"]).default("QRIS"),description:h.z.string().max(255).optional(),customer_name:h.z.string().max(100).optional(),customer_email:h.z.string().email().optional(),customer_phone:h.z.string().max(20).optional(),callback_url:h.z.string().url().optional(),expiry_minutes:h.z.number().int().positive().min(5).max(1440).default(30)});l.post("/api/v1/payments",V,F,async(s,e)=>{try{let t=It.parse(s.body),a=s.headers["x-idempotency-key"];if(a){let f=await i.getPaymentByIdempotencyKey(a);if(f)return e.status(200).json({success:!0,data:{id:f.id,external_id:f.externalId,amount:f.amount,description:f.description,customer_name:f.customerName,customer_email:f.customerEmail,status:f.status,payment_method:f.paymentMethod,qr_string:f.qrString,qr_url:f.qrUrl,expires_at:f.expiresAt,created_at:f.createdAt},meta:{idempotent:!0,sandbox_mode:!C}})}await i.getPaymentChannelByCode(t.payment_method)||await i.seedPaymentChannels();let o=await i.getPaymentChannelByCode(t.payment_method),c=o?.feePercentage||.7,g=o?.feeFlat||0,p=Math.ceil(t.amount*c/100+g),m=t.amount-p,y=new Date(Date.now()+t.expiry_minutes*60*1e3),R="",z="",N="";if(C&&j)try{let f=await j.createTransaction({method:t.payment_method,merchant_ref:t.external_id,amount:t.amount,customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone,expired_time:t.expiry_minutes,callback_url:t.callback_url});R=f.data.qr_string||"",z=f.data.qr_url||"",N=f.data.reference||"",console.log("[Payment] QRIS created via Sakurupiah",{externalId:t.external_id,providerRef:N})}catch(f){console.error("[Payment] Sakurupiah error, falling back to sandbox:",f),R=Ce(t.external_id,t.amount,t.customer_name),z=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(R)}`}else R=Ce(t.external_id,t.amount,t.customer_name),z=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(R)}`;let w=await i.createPayment({userId:s.apiKeyUserId,externalId:t.external_id,amount:t.amount,status:"pending",feeAmount:p,netAmount:m,description:t.description||null,customerName:t.customer_name||null,customerEmail:t.customer_email||null,customerPhone:t.customer_phone||null,paymentMethod:t.payment_method,qrString:R,qrUrl:z,callbackUrl:t.callback_url||null,expiresAt:y,idempotencyKey:a||null,providerRef:N||null,providerStatus:null});e.status(201).json({success:!0,data:{id:w.id,external_id:w.externalId,amount:w.amount,fee_amount:w.feeAmount,net_amount:w.netAmount,description:w.description,customer_name:w.customerName,customer_email:w.customerEmail,status:w.status,payment_method:w.paymentMethod,qr_string:w.qrString,qr_url:w.qrUrl,expires_at:w.expiresAt,created_at:w.createdAt},meta:{sandbox_mode:!C}})}catch(t){if(t instanceof h.z.ZodError)return e.status(400).json({success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid request body",details:t.errors}});console.error("Create payment error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});l.get("/api/v1/payments",V,F,async(s,e)=>{try{let t=s.query.limit?parseInt(s.query.limit):100,a=await i.getPayments(s.apiKeyUserId,t);e.json({success:!0,data:a.map(r=>({id:r.id,external_id:r.externalId,amount:r.amount,fee_amount:r.feeAmount,net_amount:r.netAmount,description:r.description,customer_name:r.customerName,status:r.status,payment_method:r.paymentMethod,expires_at:r.expiresAt,paid_at:r.paidAt,created_at:r.createdAt})),meta:{count:a.length,limit:t,sandbox_mode:!C}})}catch(t){console.error("Get payments error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});l.get("/api/v1/payments/:id",V,F,async(s,e)=>{try{let t=await i.getPaymentById(s.params.id);if(t||(t=await i.getPaymentByExternalId(s.params.id)),!t)return e.status(404).json({success:!1,error:{code:"PAYMENT_NOT_FOUND",message:"Payment not found"}});if(t.userId!==s.apiKeyUserId)return e.status(403).json({success:!1,error:{code:"FORBIDDEN",message:"You don't have permission to access this payment"}});e.json({success:!0,data:{id:t.id,external_id:t.externalId,amount:t.amount,fee_amount:t.feeAmount,net_amount:t.netAmount,description:t.description,customer_name:t.customerName,customer_email:t.customerEmail,customer_phone:t.customerPhone,status:t.status,payment_method:t.paymentMethod,qr_string:t.qrString,qr_url:t.qrUrl,expires_at:t.expiresAt,paid_at:t.paidAt,created_at:t.createdAt},meta:{sandbox_mode:!C}})}catch(t){console.error("Get payment error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});var Pt=h.z.object({status:h.z.enum(["paid","expired","failed"])});l.post("/api/v1/payments/:id/simulate",V,F,async(s,e)=>{try{if(s.apiKey?.mode!=="sandbox")return e.status(403).json({success:!1,error:{code:"SANDBOX_ONLY",message:"Payment simulation is only available in sandbox mode. Use a sandbox API key."}});let t=Pt.parse(s.body),a=await i.getPaymentById(s.params.id);if(a||(a=await i.getPaymentByExternalId(s.params.id)),!a)return e.status(404).json({success:!1,error:{code:"PAYMENT_NOT_FOUND",message:"Payment not found"}});if(a.userId!==s.apiKeyUserId)return e.status(403).json({success:!1,error:{code:"FORBIDDEN",message:"You don't have permission to access this payment"}});if(a.status!=="pending")return e.status(400).json({success:!1,error:{code:"INVALID_STATUS",message:`Cannot simulate payment. Current status is '${a.status}'. Only pending payments can be simulated.`}});let r={status:t.status};t.status==="paid"&&(r.paidAt=new Date);let o=await i.updatePayment(a.id,r);e.json({success:!0,data:{id:o.id,external_id:o.externalId,amount:o.amount,description:o.description,customer_name:o.customerName,customer_email:o.customerEmail,status:o.status,qr_string:o.qrString,expires_at:o.expiresAt,paid_at:o.paidAt||null,created_at:o.createdAt},message:`Payment status updated to '${t.status}'`})}catch(t){if(t instanceof h.z.ZodError)return e.status(400).json({success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid request body",details:t.errors}});console.error("Simulate payment error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});l.get("/api/v1/payments/:id/status",V,F,async(s,e)=>{try{let t=await i.getPaymentById(s.params.id);if(t||(t=await i.getPaymentByExternalId(s.params.id)),!t)return e.status(404).json({success:!1,error:{code:"PAYMENT_NOT_FOUND",message:"Payment not found"}});if(t.userId!==s.apiKeyUserId)return e.status(403).json({success:!1,error:{code:"FORBIDDEN",message:"You don't have permission to access this payment"}});let a=t.status,r=t.paidAt,o=t.providerStatus;if(C&&j&&t.providerRef&&t.status==="pending")try{let c=await j.checkTransactionStatus(t.providerRef);o=c.data.status;let p={PAID:"paid",SUCCESS:"paid",EXPIRED:"expired",FAILED:"failed",CANCELLED:"cancelled",PENDING:"pending"}[c.data.status.toUpperCase()]||t.status;if(p!==t.status){let m={status:p,providerStatus:c.data.status};p==="paid"&&c.data.paid_at&&(m.paidAt=new Date(c.data.paid_at),r=new Date(c.data.paid_at)),await i.updatePayment(t.id,m),a=p,console.log("[Payment] Status updated from Sakurupiah",{paymentId:t.id,oldStatus:t.status,newStatus:p})}}catch(c){console.error("[Payment] Failed to check status from Sakurupiah:",c)}else{let c=t.status==="pending"&&new Date>new Date(t.expiresAt);a=c?"expired":t.status,c&&t.status==="pending"&&await i.updatePayment(t.id,{status:"expired"})}e.json({success:!0,data:{id:t.id,external_id:t.externalId,status:a,provider_status:o,amount:t.amount,fee_amount:t.feeAmount,net_amount:t.netAmount,paid_at:r||null}})}catch(t){console.error("Get payment status error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});l.post("/api/v1/webhooks/sakurupiah",At,ie,async(s,e)=>{try{await K();let t=s.headers["x-signature"]||s.headers["x-sakurupiah-signature"],a=JSON.stringify(s.body);await i.createWebhookLog({paymentId:s.body?.reference||"unknown",eventType:s.body?.status||"unknown",payload:a,signature:t||"",verified:!1,createdAt:new Date}),(!C||!j)&&console.warn("[Webhook] Sakurupiah not configured, processing webhook in sandbox mode");let r=!0;if(C&&j&&t&&(r=j.verifyWebhookSignature(a,t),!r))return console.warn("[Webhook] Invalid signature received"),e.status(401).json({success:!1,error:{code:"INVALID_SIGNATURE",message:"Webhook signature verification failed"}});let{reference:o,merchant_ref:c,status:g,amount:p,paid_at:m}=s.body;if(!o&&!c)return e.status(400).json({success:!1,error:{code:"INVALID_PAYLOAD",message:"Missing reference or merchant_ref in webhook payload"}});let y=await i.getPayments("",1e3),R=y.find(f=>f.providerRef===o);if(!R&&c&&(R=y.find(f=>f.externalId===c||f.id.includes(c))),!R)return console.warn("[Webhook] Payment not found for reference:",o),e.status(404).json({success:!1,error:{code:"PAYMENT_NOT_FOUND",message:"Payment not found for this webhook"}});let N={PAID:"paid",SUCCESS:"paid",EXPIRED:"expired",FAILED:"failed",CANCELLED:"cancelled",PENDING:"pending"}[g?.toUpperCase()]||g?.toLowerCase()||R.status,w={status:N,providerStatus:g};N==="paid"&&m?w.paidAt=new Date(m):N==="paid"&&!R.paidAt&&(w.paidAt=new Date),await i.updatePayment(R.id,w),await i.createWebhookLog({paymentId:R.id,eventType:`payment.${N}`,payload:a,signature:t||"",verified:r,createdAt:new Date}),console.log("[Webhook] Payment status updated",{paymentId:R.id,oldStatus:R.status,newStatus:N,reference:o}),e.status(200).json({success:!0,message:"Webhook processed successfully"})}catch(t){console.error("[Webhook] Error processing webhook:",t),e.status(500).json({success:!1,error:{code:"WEBHOOK_PROCESSING_ERROR",message:"Failed to process webhook"}})}});l.get("/api/v1/payment-channels",V,ie,async(s,e)=>{try{await K();let a=(await i.getPaymentChannels()).filter(r=>r.isActive);e.json({success:!0,data:a.map(r=>({code:r.code,name:r.name,type:r.type,fee_percentage:r.feePercentage,fee_flat:r.feeFlat,min_amount:r.minAmount,max_amount:r.maxAmount,icon_url:r.iconUrl})),meta:{count:a.length,sandbox_mode:!C}})}catch(t){console.error("Get payment channels error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});l.use((s,e,t,a)=>{let r=s.status||s.statusCode||500,o=s.message||"Internal Server Error";t.status(r).json({message:o})});var Ke=(0,Ne.default)(l);module.exports=Ke;module.exports.handler=Ke;
