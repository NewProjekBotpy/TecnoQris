import { createRequire } from 'module'; const require = createRequire(import.meta.url);
var Le=Object.defineProperty;var J=(s,e)=>()=>(s&&(e=s(s=0)),e);var Z=(s,e)=>{for(var t in e)Le(s,t,{get:e[t],enumerable:!0})};var ae={};Z(ae,{apiKeys:()=>h,insertApiKeySchema:()=>Ve,insertPaymentChannelSchema:()=>Ge,insertPaymentSchema:()=>Me,insertQrCodeSchema:()=>se,insertTransactionSchema:()=>ee,insertUserSchema:()=>me,insertWalletSchema:()=>te,insertWebhookLogSchema:()=>$e,paymentChannels:()=>k,payments:()=>w,qrCodes:()=>S,selectApiKeySchema:()=>ze,selectPaymentChannelSchema:()=>Je,selectPaymentSchema:()=>Qe,selectQrCodeSchema:()=>qe,selectTransactionSchema:()=>We,selectUserSchema:()=>Be,selectWalletSchema:()=>Oe,selectWebhookLogSchema:()=>Ye,transactions:()=>P,updatePaymentChannelSchema:()=>Xe,updatePaymentSchema:()=>Fe,updateWebhookLogSchema:()=>He,users:()=>R,wallets:()=>v,webhookLogs:()=>D});import{pgTable as B,text as c,integer as Ke,boolean as Y,timestamp as U,real as T,uuid as x}from"drizzle-orm/pg-core";import{createInsertSchema as N,createSelectSchema as W}from"drizzle-zod";var R,P,v,S,h,w,D,k,me,Be,ee,We,te,Oe,se,qe,Ve,ze,Me,Fe,Qe,$e,He,Ye,Ge,Xe,Je,re=J(()=>{"use strict";R=B("users",{id:x("id").defaultRandom().primaryKey(),username:c("username").notNull().unique(),password:c("password").notNull(),name:c("name").notNull(),email:c("email").notNull(),role:c("role").notNull().default("Merchant"),balance:T("balance").notNull().default(0),avatar:c("avatar")}),P=B("transactions",{id:x("id").defaultRandom().primaryKey(),userId:x("user_id").notNull().references(()=>R.id),transactionId:c("transaction_id").notNull(),type:c("type").notNull(),amount:T("amount").notNull(),status:c("status").notNull().default("pending"),customer:c("customer").notNull(),method:c("method").notNull(),createdAt:U("created_at",{withTimezone:!0}).notNull().defaultNow()}),v=B("wallets",{id:x("id").defaultRandom().primaryKey(),userId:x("user_id").notNull().references(()=>R.id),name:c("name").notNull(),type:c("type").notNull(),accountNumber:c("account_number"),bankName:c("bank_name"),isDefault:Y("is_default").notNull().default(!1),balance:T("balance").notNull().default(0),createdAt:U("created_at",{withTimezone:!0}).notNull().defaultNow()}),S=B("qr_codes",{id:x("id").defaultRandom().primaryKey(),userId:x("user_id").notNull().references(()=>R.id),name:c("name").notNull(),amount:T("amount"),description:c("description"),qrData:c("qr_data").notNull(),isActive:Y("is_active").notNull().default(!0),createdAt:U("created_at",{withTimezone:!0}).notNull().defaultNow()}),h=B("api_keys",{id:x("id").defaultRandom().primaryKey(),userId:x("user_id").notNull().references(()=>R.id),name:c("name").notNull(),key:c("key").notNull().unique(),mode:c("mode").notNull().default("live"),isActive:Y("is_active").notNull().default(!0),createdAt:U("created_at",{withTimezone:!0}).notNull().defaultNow(),lastUsed:U("last_used",{withTimezone:!0}),requestCount:Ke("request_count").notNull().default(0)}),w=B("payments",{id:x("id").defaultRandom().primaryKey(),userId:x("user_id").notNull().references(()=>R.id),externalId:c("external_id").notNull(),amount:T("amount").notNull(),description:c("description"),customerName:c("customer_name"),customerEmail:c("customer_email"),customerPhone:c("customer_phone"),status:c("status").notNull().default("pending"),qrString:c("qr_string").notNull(),qrUrl:c("qr_url"),expiresAt:U("expires_at",{withTimezone:!0}).notNull(),paidAt:U("paid_at",{withTimezone:!0}),createdAt:U("created_at",{withTimezone:!0}).notNull().defaultNow(),paymentMethod:c("payment_method").notNull(),providerRef:c("provider_ref"),providerStatus:c("provider_status"),signatureHash:c("signature_hash"),idempotencyKey:c("idempotency_key").unique(),callbackUrl:c("callback_url"),feeAmount:T("fee_amount").notNull().default(0),netAmount:T("net_amount")}),D=B("webhook_logs",{id:x("id").defaultRandom().primaryKey(),paymentId:x("payment_id").notNull().references(()=>w.id),eventType:c("event_type").notNull(),payload:c("payload").notNull(),signature:c("signature").notNull(),verified:Y("verified").notNull().default(!1),processedAt:U("processed_at",{withTimezone:!0}),createdAt:U("created_at",{withTimezone:!0}).notNull().defaultNow()}),k=B("payment_channels",{id:x("id").defaultRandom().primaryKey(),code:c("code").notNull().unique(),name:c("name").notNull(),type:c("type").notNull(),isActive:Y("is_active").notNull().default(!0),feePercentage:T("fee_percentage").notNull().default(0),feeFlat:T("fee_flat").notNull().default(0),minAmount:T("min_amount").notNull().default(1e3),maxAmount:T("max_amount").notNull().default(1e8),iconUrl:c("icon_url")}),me=N(R).omit({id:!0}),Be=W(R),ee=N(P).omit({id:!0}),We=W(P),te=N(v).omit({id:!0}),Oe=W(v),se=N(S).omit({id:!0}),qe=W(S),Ve=N(h).omit({id:!0,lastUsed:!0,requestCount:!0}),ze=W(h),Me=N(w).omit({id:!0,paidAt:!0,createdAt:!0}),Fe=N(w).omit({id:!0,createdAt:!0}).partial(),Qe=W(w),$e=N(D).omit({id:!0,processedAt:!0}),He=N(D).omit({id:!0,createdAt:!0}).partial(),Ye=W(D),Ge=N(k).omit({id:!0}),Xe=N(k).omit({id:!0}).partial(),Je=W(k)});var _e={};Z(_e,{db:()=>u,getDb:()=>ut,getInitializationError:()=>ot,getPool:()=>ct,initializeDatabase:()=>it,isDatabaseConfigured:()=>nt,pool:()=>dt});import{drizzle as Ze}from"drizzle-orm/node-postgres";import{drizzle as et}from"drizzle-orm/postgres-js";import tt from"pg";import st from"postgres";function nt(){return!!process.env.DATABASE_URL}function ot(){return V}async function it(){if(pe&&K)return{success:!0,pool:L,db:K};if(V)return{success:!1,error:V.message};let s=process.env.DATABASE_URL;if(!s)return V=new Error("DATABASE_URL must be set. Please configure the DATABASE_URL environment variable in Vercel."),console.error("[DB] DATABASE_URL is not set"),{success:!1,error:V.message};try{let e=s.includes("pgbouncer=true")||s.includes("pooler.supabase.com");if(console.log("[DB] Initializing database...",{isPgBouncer:e,isVercel:Pe,isProduction:rt}),e||Pe){console.log("[DB] Using postgres.js driver with prepare: false for PgBouncer compatibility");let t=st(s,{prepare:!1,max:1,idle_timeout:20,connect_timeout:10,ssl:"require"});console.log("[DB] Testing database connection...");let a=await t`SELECT NOW() as now`;return console.log("[DB] Connection test successful:",a[0]?.now),K=et(t,{schema:ae}),pe=!0,console.log("[DB] Database initialized successfully with postgres.js driver"),{success:!0,db:K}}else{console.log("[DB] Using node-postgres driver for local development");let t={connectionString:s,max:10,idleTimeoutMillis:3e4,connectionTimeoutMillis:1e4,statement_timeout:6e4};(s.includes("neon.tech")||s.includes("supabase"))&&(t.ssl={rejectUnauthorized:!1}),L=new at(t),L.on("error",r=>{console.error("[DB] Unexpected pool error:",r)}),console.log("[DB] Testing database connection...");let a=await L.connect();try{let r=await a.query("SELECT NOW() as now");console.log("[DB] Connection test successful:",r.rows[0]?.now)}finally{a.release()}return K=Ze(L,{schema:ae}),pe=!0,console.log("[DB] Database initialized successfully with node-postgres driver"),{success:!0,pool:L,db:K}}}catch(e){return V=e,console.error("[DB] Failed to initialize database:",e?.message),console.error("[DB] Error stack:",e?.stack),{success:!1,error:e?.message}}}function ut(){return K}function ct(){return L}var at,rt,Pe,L,K,V,pe,dt,u,ge=J(()=>{"use strict";re();({Pool:at}=tt),rt=!0,Pe=process.env.VERCEL==="1"||process.env.VERCEL_ENV!==void 0,L=null,K=null,V=null,pe=!1;dt=new Proxy({},{get(s,e){if(!L)throw new Error("Database pool not initialized. Call initializeDatabase() first.");return L[e]}}),u=new Proxy({},{get(s,e){if(!K)throw new Error("Database not initialized. Call initializeDatabase() first.");return K[e]}})});var Re={};Z(Re,{DrizzleStorage:()=>ne,storage:()=>gt});import we from"crypto";import{eq as m,desc as z,and as be,gte as lt,lte as mt,sql as pt}from"drizzle-orm";var ne,gt,xe=J(()=>{"use strict";ge();re();ne=class{async getUser(e){return(await u.select().from(R).where(m(R.id,e)).limit(1))[0]}async getUserByUsername(e){return(await u.select().from(R).where(m(R.username,e)).limit(1))[0]}async createUser(e){return(await u.insert(R).values({...e,role:e.role||"Merchant",balance:e.balance||0,avatar:e.avatar||null}).returning())[0]}async updateUser(e,t){return(await u.update(R).set(t).where(m(R.id,e)).returning())[0]}async getTransactions(e,t=100){return u.select().from(P).where(m(P.userId,e)).orderBy(z(P.createdAt)).limit(t)}async getTransactionById(e){return(await u.select().from(P).where(m(P.id,e)).limit(1))[0]}async createTransaction(e){return(await u.insert(P).values({...e,status:e.status||"pending"}).returning())[0]}async createTransactionsBatch(e){let t=e.map(a=>({...a,status:a.status||"pending"}));return u.insert(P).values(t).returning()}async updateTransaction(e,t){return(await u.update(P).set(t).where(m(P.id,e)).returning())[0]}async getWallets(e){return u.select().from(v).where(m(v.userId,e)).orderBy(z(v.createdAt))}async getWalletById(e){return(await u.select().from(v).where(m(v.id,e)).limit(1))[0]}async createWallet(e){return(await u.insert(v).values({...e,isDefault:e.isDefault??!1,balance:e.balance||0}).returning())[0]}async updateWallet(e,t){return(await u.update(v).set(t).where(m(v.id,e)).returning())[0]}async deleteWallet(e){await u.delete(v).where(m(v.id,e))}async getQrCodes(e){return u.select().from(S).where(m(S.userId,e)).orderBy(z(S.createdAt))}async getQrCodeById(e){return(await u.select().from(S).where(m(S.id,e)).limit(1))[0]}async createQrCode(e){return(await u.insert(S).values({...e,isActive:e.isActive??!0}).returning())[0]}async updateQrCode(e,t){return(await u.update(S).set(t).where(m(S.id,e)).returning())[0]}async deleteQrCode(e){await u.delete(S).where(m(S.id,e))}async getApiKeys(e){return u.select().from(h).where(m(h.userId,e)).orderBy(z(h.createdAt))}async getApiKeyByValue(e){return(await u.select().from(h).where(m(h.key,e)).limit(1))[0]}async createOrResetApiKey(e,t,a){await u.delete(h).where(be(m(h.userId,e),m(h.mode,t)));let r=t==="sandbox"?"Sandbox Key":"Live Key";return(await u.insert(h).values({userId:e,name:r,key:a,mode:t,isActive:!0}).returning())[0]}async createInitialApiKeys(e){let t="sk_sandbox_"+we.randomBytes(24).toString("hex"),a="sk_live_"+we.randomBytes(24).toString("hex");return u.insert(h).values([{userId:e,name:"Sandbox Key",key:t,mode:"sandbox",isActive:!0},{userId:e,name:"Live Key",key:a,mode:"live",isActive:!0}]).returning()}async updateApiKeyStatus(e,t){return(await u.update(h).set({isActive:t}).where(m(h.id,e)).returning())[0]}async updateApiKeyLastUsed(e){await u.update(h).set({lastUsed:new Date}).where(m(h.id,e))}async incrementApiKeyUsage(e){await u.update(h).set({lastUsed:new Date,requestCount:pt`${h.requestCount} + 1`}).where(m(h.id,e))}async getPayments(e,t=100){return u.select().from(w).where(m(w.userId,e)).orderBy(z(w.createdAt)).limit(t)}async getPaymentById(e){return(await u.select().from(w).where(m(w.id,e)).limit(1))[0]}async getPaymentByExternalId(e){return(await u.select().from(w).where(m(w.externalId,e)).limit(1))[0]}async getPaymentByIdempotencyKey(e){return(await u.select().from(w).where(m(w.idempotencyKey,e)).limit(1))[0]}async createPayment(e){return(await u.insert(w).values({...e,status:e.status||"pending"}).returning())[0]}async updatePayment(e,t){return(await u.update(w).set(t).where(m(w.id,e)).returning())[0]}async getWebhookLogs(e){return u.select().from(D).where(m(D.paymentId,e)).orderBy(z(D.createdAt))}async createWebhookLog(e){return(await u.insert(D).values(e).returning())[0]}async updateWebhookLog(e,t){return(await u.update(D).set(t).where(m(D.id,e)).returning())[0]}async getPaymentChannels(){return u.select().from(k).orderBy(k.code)}async getPaymentChannelByCode(e){return(await u.select().from(k).where(m(k.code,e)).limit(1))[0]}async createPaymentChannel(e){return(await u.insert(k).values({...e,isActive:e.isActive??!0,feePercentage:e.feePercentage??0,feeFlat:e.feeFlat??0,minAmount:e.minAmount??1e3,maxAmount:e.maxAmount??1e8,iconUrl:e.iconUrl||null}).returning())[0]}async updatePaymentChannel(e,t){return(await u.update(k).set(t).where(m(k.id,e)).returning())[0]}async seedPaymentChannels(){let e=[{code:"QRIS",name:"QRIS Payment",type:"qris",isActive:!0,feePercentage:.7,feeFlat:0,minAmount:1e3,maxAmount:1e7},{code:"BCAVA",name:"BCA Virtual Account",type:"va",isActive:!0,feePercentage:0,feeFlat:4e3,minAmount:1e4,maxAmount:1e8},{code:"BRIVA",name:"BRI Virtual Account",type:"va",isActive:!0,feePercentage:0,feeFlat:4e3,minAmount:1e4,maxAmount:1e8},{code:"BNIVA",name:"BNI Virtual Account",type:"va",isActive:!0,feePercentage:0,feeFlat:4e3,minAmount:1e4,maxAmount:1e8},{code:"GOPAY",name:"GoPay",type:"ewallet",isActive:!0,feePercentage:2,feeFlat:0,minAmount:1e3,maxAmount:1e7},{code:"DANA",name:"DANA",type:"ewallet",isActive:!0,feePercentage:1.5,feeFlat:0,minAmount:1e3,maxAmount:1e7},{code:"OVO",name:"OVO",type:"ewallet",isActive:!0,feePercentage:2,feeFlat:0,minAmount:1e3,maxAmount:1e7}];for(let t of e)await this.getPaymentChannelByCode(t.code)||await this.createPaymentChannel(t)}async getRevenueStats(e,t,a){let r=[m(P.userId,e)];t&&r.push(lt(P.createdAt,t)),a&&r.push(mt(P.createdAt,a));let n=await u.select().from(P).where(be(...r)),i=0,g=0,p=0,l=0;for(let y of n)i+=y.amount,y.status==="success"?g+=y.amount:y.status==="pending"?p+=y.amount:y.status==="failed"&&(l+=y.amount);return{total:i,success:g,pending:p,failed:l}}async getTransactionStats(e){let t=await u.select().from(P).where(m(P.userId,e)),a=0,r=0,n=0,i=0;for(let g of t)a++,g.status==="success"?r++:g.status==="pending"?n++:g.status==="failed"&&i++;return{total:a,success:r,pending:n,failed:i}}},gt=new ne});var Ee={};Z(Ee,{SakurupiahApiError:()=>F,SakurupiahConfigError:()=>M,SakurupiahError:()=>E,SakurupiahNetworkError:()=>ie,SakurupiahService:()=>ce,SakurupiahSignatureError:()=>ye,SakurupiahTimeoutError:()=>ue,default:()=>ft,getSakurupiahService:()=>Se,resetSakurupiahService:()=>yt});import{createHmac as ve}from"crypto";function Se(){return oe||(oe=new ce),oe}function yt(){oe=null}var E,M,ie,ue,F,ye,fe,ce,oe,ft,ke=J(()=>{"use strict";E=class extends Error{constructor(t,a,r,n){super(t);this.code=a;this.statusCode=r;this.response=n;this.name="SakurupiahError"}},M=class extends E{constructor(e){super(e,"CONFIG_ERROR"),this.name="SakurupiahConfigError"}},ie=class extends E{constructor(t,a){super(t,"NETWORK_ERROR");this.originalError=a;this.name="SakurupiahNetworkError"}},ue=class extends E{constructor(e="Request timed out"){super(e,"TIMEOUT_ERROR"),this.name="SakurupiahTimeoutError"}},F=class extends E{constructor(e,t,a){super(e,"API_ERROR",t,a),this.name="SakurupiahApiError"}},ye=class extends E{constructor(e="Invalid webhook signature"){super(e,"SIGNATURE_ERROR"),this.name="SakurupiahSignatureError"}},fe=class{prefix="[Sakurupiah]";formatLog(e,t,a){return{timestamp:new Date().toISOString(),level:e,message:`${this.prefix} ${t}`,data:a}}info(e,t){let a=this.formatLog("info",e,t);console.log(a.timestamp,a.message,t?JSON.stringify(t):"")}warn(e,t){let a=this.formatLog("warn",e,t);console.warn(a.timestamp,a.message,t?JSON.stringify(t):"")}error(e,t){let a=this.formatLog("error",e,t);console.error(a.timestamp,a.message,t?JSON.stringify(t):"")}debug(e,t){if(process.env.SAKURUPIAH_DEBUG==="true"){let a=this.formatLog("debug",e,t);console.debug(a.timestamp,a.message,t?JSON.stringify(t):"")}}},ce=class{config;logger;MAX_RETRIES=3;REQUEST_TIMEOUT=3e4;RETRY_BASE_DELAY=1e3;constructor(){this.logger=new fe,this.config=this.loadConfig(),this.logger.info("Service initialized",{mode:this.config.mode,baseUrl:this.config.baseUrl})}loadConfig(){let e=process.env.SAKURUPIAH_API_ID,t=process.env.SAKURUPIAH_API_KEY,a=process.env.SAKURUPIAH_MODE||"sandbox";if(!e)throw new M("SAKURUPIAH_API_ID environment variable is required");if(!t)throw new M("SAKURUPIAH_API_KEY environment variable is required");if(a!=="sandbox"&&a!=="production")throw new M('SAKURUPIAH_MODE must be either "sandbox" or "production"');return{apiId:e,apiKey:t,mode:a,baseUrl:a==="production"?"https://sakurupiah.id/api/":"https://sakurupiah.id/api-sanbox/"}}getConfig(){return{apiId:this.config.apiId,mode:this.config.mode,baseUrl:this.config.baseUrl}}generateSignature(e,t,a){let r=`${this.config.apiId}${e}${t}${a}`,n=ve("sha256",this.config.apiKey).update(r).digest("hex");return this.logger.debug("Generated signature",{method:e,merchantRef:t,amount:a,signaturePreview:n.substring(0,16)+"..."}),n}verifyWebhookSignature(e,t){if(!e||!t)return this.logger.warn("Missing payload or signature for verification"),!1;try{let a=ve("sha256",this.config.apiKey).update(e).digest("hex"),r=a===t;return this.logger.debug("Webhook signature verification",{isValid:r,receivedSignaturePreview:t.substring(0,16)+"...",expectedSignaturePreview:a.substring(0,16)+"..."}),r}catch(a){return this.logger.error("Error verifying webhook signature",{error:a}),!1}}async sleep(e){return new Promise(t=>setTimeout(t,e))}async makeRequest(e,t){let a=`${this.config.baseUrl}${e}`,r=`req_${Date.now()}_${Math.random().toString(36).substring(7)}`,n=null;for(let i=1;i<=this.MAX_RETRIES;i++){let g=new AbortController,p=setTimeout(()=>g.abort(),this.REQUEST_TIMEOUT);try{this.logger.info(`Request attempt ${i}/${this.MAX_RETRIES}`,{requestId:r,endpoint:e,attempt:i}),this.logger.debug("Request details",{requestId:r,url:a,body:{...t,signature:t.signature?"[REDACTED]":void 0}});let l=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","User-Agent":"SakurupiahService/1.0"},body:JSON.stringify(t),signal:g.signal});clearTimeout(p);let y=await l.json();if(this.logger.debug("Response received",{requestId:r,status:l.status,data:y}),!l.ok)throw new F(y.message||`HTTP ${l.status}: ${l.statusText}`,l.status,y);if(y.status==="error"||y.status==="failed")throw new F(y.message||"API returned error status",l.status,y);return this.logger.info("Request successful",{requestId:r,endpoint:e,attempt:i}),y}catch(l){if(clearTimeout(p),n=l,l instanceof F&&l.statusCode&&l.statusCode>=400&&l.statusCode<500)throw this.logger.error("Client error - not retrying",{requestId:r,error:l.message,statusCode:l.statusCode}),l;if(l.name==="AbortError"&&(n=new ue(`Request timed out after ${this.REQUEST_TIMEOUT}ms`)),i<this.MAX_RETRIES){let y=this.RETRY_BASE_DELAY*Math.pow(2,i-1);this.logger.warn(`Request failed, retrying in ${y}ms`,{requestId:r,attempt:i,error:n.message,nextRetryIn:y}),await this.sleep(y)}}}throw this.logger.error("All retry attempts exhausted",{requestId:r,endpoint:e,error:n?.message}),n instanceof E?n:new ie(`Request failed after ${this.MAX_RETRIES} attempts: ${n?.message}`,n)}async listPaymentChannels(){this.logger.info("Fetching payment channels");let e={api_id:this.config.apiId};try{let t=await this.makeRequest("payment-channels",e);return this.logger.info("Payment channels fetched",{count:t.data?.length||0}),t}catch(t){throw this.logger.error("Failed to fetch payment channels",{error:t}),t}}async createTransaction(e){if(this.logger.info("Creating transaction",{method:e.method,merchantRef:e.merchant_ref,amount:e.amount}),!e.method)throw new E("Payment method is required","VALIDATION_ERROR");if(!e.merchant_ref)throw new E("Merchant reference is required","VALIDATION_ERROR");if(!e.amount||e.amount<=0)throw new E("Valid amount is required","VALIDATION_ERROR");let t=this.generateSignature(e.method,e.merchant_ref,e.amount),a={api_id:this.config.apiId,method:e.method,merchant_ref:e.merchant_ref,amount:e.amount,signature:t};e.customer_name&&(a.customer_name=e.customer_name),e.customer_email&&(a.customer_email=e.customer_email),e.customer_phone&&(a.customer_phone=e.customer_phone),e.callback_url&&(a.callback_url=e.callback_url),e.return_url&&(a.return_url=e.return_url),e.expired_time&&(a.expired_time=e.expired_time);try{let r=await this.makeRequest("create-transaction",a);return this.logger.info("Transaction created successfully",{reference:r.data?.reference,merchantRef:r.data?.merchant_ref,amount:r.data?.amount,total:r.data?.total}),r}catch(r){throw this.logger.error("Failed to create transaction",{merchantRef:e.merchant_ref,error:r}),r}}async checkTransactionStatus(e){if(this.logger.info("Checking transaction status",{reference:e}),!e)throw new E("Transaction reference is required","VALIDATION_ERROR");let t={api_id:this.config.apiId,reference:e};try{let a=await this.makeRequest("check-status",t);return this.logger.info("Transaction status retrieved",{reference:a.data?.reference,status:a.data?.status}),a}catch(a){throw this.logger.error("Failed to check transaction status",{reference:e,error:a}),a}}parseWebhookPayload(e){try{return JSON.parse(e)}catch{throw new E("Failed to parse webhook payload","PARSE_ERROR")}}validateAndParseWebhook(e,t){if(!this.verifyWebhookSignature(e,t))return this.logger.warn("Invalid webhook signature received"),{isValid:!1,data:null};try{let r=this.parseWebhookPayload(e);return this.logger.info("Webhook validated and parsed",{reference:r.reference,status:r.status}),{isValid:!0,data:r}}catch(r){return this.logger.error("Failed to parse webhook payload after validation",{error:r}),{isValid:!1,data:null}}}},oe=null;ft=Se});re();import he from"express";import ht from"serverless-http";import At from"crypto";import{SignJWT as It,jwtVerify as Pt}from"jose";import{z as A}from"zod";var de=null,Q=null,o=null,O=null,C=!1,Ce=!1;function G(){return!!process.env.DATABASE_URL}async function De(){return de||(de=await import("bcryptjs")),de.default||de}async function q(){if(Ce&&o!==null)return!0;if(!G())return console.error("[Init] DATABASE_URL not configured"),!1;Q||(Q=await Promise.resolve().then(()=>(ge(),_e)));let s=await Q.initializeDatabase();if(!s.success)return console.error("[Init] Failed to initialize database:",s.error),!1;try{o=(await Promise.resolve().then(()=>(xe(),Re))).storage,console.log("[Init] Database and storage initialized successfully")}catch(e){return console.error("[Init] Failed to initialize storage:",e?.message),!1}try{O=(await Promise.resolve().then(()=>(ke(),Ee))).getSakurupiahService(),C=!0,console.log("[Payment] Sakurupiah service initialized successfully")}catch(e){e?.message?.includes("SAKURUPIAH")?console.warn("[Payment] Sakurupiah not configured - running in sandbox mode"):console.error("[Payment] Failed to initialize Sakurupiah service:",e?.message),C=!1}return Ce=!0,!0}function le(s,e,t){if(!G())return e.status(503).json({message:"Database not configured",error:"DATABASE_URL environment variable is not set. Please configure it in Vercel dashboard under Settings > Environment Variables.",code:"DATABASE_NOT_CONFIGURED"});if(Q){let a=Q.getInitializationError?.();if(a)return e.status(503).json({message:"Database initialization failed",error:a.message,code:"DATABASE_INIT_FAILED"})}if(!o)return e.status(503).json({message:"Service not ready",error:"Database connection is being established. Please try again in a moment.",code:"SERVICE_NOT_READY"});t()}var d=he(),Ue=new TextEncoder().encode(process.env.SESSION_SECRET||"fintech-dashboard-secret-key-2024");d.set("trust proxy",1);d.use(he.json());d.use(he.urlencoded({extended:!1}));d.get("/api/ping",(s,e)=>{e.json({status:"ok",timestamp:Date.now()})});async function je(s){return await new It({userId:s}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("24h").sign(Ue)}async function _t(s){try{let{payload:e}=await Pt(s,Ue);return typeof e.userId=="string"?{userId:e.userId,iat:e.iat,exp:e.exp}:null}catch{return null}}function wt(s){let e=s.headers.authorization;if(e&&e.startsWith("Bearer "))return e.slice(7);let t=s.headers.cookie;if(t){let r=t.split(";").map(n=>n.trim()).find(n=>n.startsWith("auth_token="));if(r)return r.split("=")[1]}return null}async function I(s,e,t){if(await q(),!G()||!o)return e.status(503).json({message:"Service unavailable",error:"Database not configured. Please check DATABASE_URL in Vercel environment variables.",code:"DATABASE_NOT_CONFIGURED"});let a=wt(s);if(!a)return e.status(401).json({message:"Unauthorized"});let r=await _t(a);if(!r||!r.userId)return e.status(401).json({message:"Invalid or expired token"});s.userId=r.userId,t()}async function X(s,e,t){if(await q(),!G()||!o)return e.status(503).json({success:!1,error:{code:"DATABASE_NOT_CONFIGURED",message:"Database not configured. Please check DATABASE_URL in Vercel environment variables."}});let a=s.headers["x-api-key"];if(!a)return e.status(401).json({success:!1,error:{code:"MISSING_API_KEY",message:"API key is required. Please provide X-API-Key header."}});try{let r=await o.getApiKeyByValue(a);if(!r)return e.status(401).json({success:!1,error:{code:"INVALID_API_KEY",message:"Invalid API key. Please check your API key and try again."}});if(!r.isActive)return e.status(403).json({success:!1,error:{code:"INACTIVE_API_KEY",message:"This API key has been deactivated."}});await o.incrementApiKeyUsage(r.id),s.apiKey=r,s.apiKeyUserId=r.userId,t()}catch(r){return console.error("API key auth error:",r?.message||r),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}}function Te(s,e,t="QRIS Merchant"){let a=Date.now().toString(36);return`00020101021226580016ID.CO.QRIS.WWW0215ID${s.slice(0,15)}0303UMI51440014ID.CO.QRIS.WWW0215ID${a}53033605802ID5913${t.slice(0,13)}6007Jakarta61051234062070703A01${e.toString().padStart(13,"0")}6304`}var Ne=new Map;function Ae(s){return(e,t,a)=>{let r=e.headers["x-api-key"],n=e.ip||e.socket.remoteAddress||"unknown",i=`${s.keyPrefix||"default"}:${r||n}`,g=Date.now(),p=Ne.get(i);if((!p||p.resetAt<g)&&(p={count:0,resetAt:g+s.windowMs},Ne.set(i,p)),p.count++,t.setHeader("X-RateLimit-Limit",s.maxRequests),t.setHeader("X-RateLimit-Remaining",Math.max(0,s.maxRequests-p.count)),t.setHeader("X-RateLimit-Reset",p.resetAt),p.count>s.maxRequests)return t.status(429).json({success:!1,error:{code:"RATE_LIMIT_EXCEEDED",message:"Too many requests. Please try again later.",retry_after:Math.ceil((p.resetAt-g)/1e3)}});a()}}var Ie=Ae({windowMs:60*1e3,maxRequests:10,keyPrefix:"auth"}),$=Ae({windowMs:60*1e3,maxRequests:100,keyPrefix:"api_v1"}),bt=Ae({windowMs:60*1e3,maxRequests:1e3,keyPrefix:"webhook"});d.get("/api/health",async(s,e)=>{await q();let t=C?"configured":"not_configured",a=G(),r=Q?.getInitializationError?.()||null,n="unknown";if(!a)n="not_configured: DATABASE_URL not set";else if(r)n=`error: ${r.message}`;else if(o)try{await o.getPaymentChannels(),n="connected"}catch(i){n=`error: ${i.message}`}else n="initializing";e.json({status:a&&o?"ok":"degraded",timestamp:new Date().toISOString(),environment:"production",vercel:process.env.VERCEL==="1"||!!process.env.VERCEL_ENV,services:{postgresql:{configured:a,connection:n,error:a?r?.message||null:"DATABASE_URL not set"},sakurupiah:t},env_check:{DATABASE_URL:process.env.DATABASE_URL?"set":"missing",SESSION_SECRET:process.env.SESSION_SECRET?"set":"missing",SAKURUPIAH_API_ID:process.env.SAKURUPIAH_API_ID?"set":"missing",SAKURUPIAH_API_KEY:process.env.SAKURUPIAH_API_KEY?"set":"missing"}})});d.post("/api/auth/register",Ie,le,async(s,e)=>{try{await q();let t=me.parse(s.body);if(await o.getUserByUsername(t.username))return e.status(400).json({message:"Username already exists"});let n=await(await De()).hash(t.password,10),i=await o.createUser({...t,password:n}),g=await je(i.id);e.setHeader("Set-Cookie",`auth_token=${g}; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=86400`);let{password:p,...l}=i;e.status(201).json({...l,token:g})}catch(t){if(console.error("Registration error:",t?.message||t),console.error("Registration error stack:",t?.stack),t instanceof A.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});if(t?.message?.includes("DATABASE_URL")||t?.message?.includes("database")||t?.code==="ECONNREFUSED")return e.status(503).json({message:"Database connection error",error:"Unable to connect to database. Please check DATABASE_URL environment variable in Vercel.",code:"DATABASE_CONNECTION_ERROR"});e.status(500).json({message:"Internal server error",error:void 0,code:"INTERNAL_ERROR"})}});d.post("/api/auth/login",Ie,le,async(s,e)=>{try{await q();let{username:t,password:a}=s.body;if(!t||!a)return e.status(400).json({message:"Username and password are required"});let r=await o.getUserByUsername(t);if(!r)return e.status(401).json({message:"Invalid credentials"});if(!await(await De()).compare(a,r.password))return e.status(401).json({message:"Invalid credentials"});let g=await je(r.id);e.setHeader("Set-Cookie",`auth_token=${g}; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=86400`);let{password:p,...l}=r;e.json({...l,token:g})}catch(t){if(console.error("Login error:",t?.message||t),t?.message?.includes("DATABASE_URL")||t?.message?.includes("database")||t?.code==="ECONNREFUSED")return e.status(503).json({message:"Database connection error",error:"Unable to connect to database. Please check DATABASE_URL environment variable in Vercel.",code:"DATABASE_CONNECTION_ERROR"});e.status(500).json({message:"Internal server error",code:"INTERNAL_ERROR"})}});d.post("/api/auth/logout",Ie,(s,e)=>{e.setHeader("Set-Cookie","auth_token=; Path=/; HttpOnly; Secure; SameSite=None; Max-Age=0"),e.json({message:"Logged out successfully"})});d.get("/api/auth/me",I,async(s,e)=>{try{let t=await o.getUser(s.userId);if(!t)return e.status(404).json({message:"User not found"});let{password:a,...r}=t;e.json(r)}catch{e.status(500).json({message:"Internal server error"})}});d.get("/api/transactions",I,async(s,e)=>{try{let t=s.query.limit?parseInt(s.query.limit):100,a=await o.getTransactions(s.userId,t);e.json(a)}catch{e.status(500).json({message:"Internal server error"})}});d.get("/api/transactions/:id",I,async(s,e)=>{try{let t=await o.getTransactionById(s.params.id);if(!t)return e.status(404).json({message:"Transaction not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});d.post("/api/transactions",I,async(s,e)=>{try{let t=ee.parse({...s.body,userId:s.userId}),a=await o.createTransaction(t);e.status(201).json(a)}catch(t){if(t instanceof A.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});d.put("/api/transactions/:id",I,async(s,e)=>{try{let t=await o.getTransactionById(s.params.id);if(!t)return e.status(404).json({message:"Transaction not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});let a=ee.partial().parse(s.body),r=await o.updateTransaction(s.params.id,a);e.json(r)}catch(t){if(t instanceof A.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});d.get("/api/wallets",I,async(s,e)=>{try{let t=await o.getWallets(s.userId);e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});d.get("/api/wallets/:id",I,async(s,e)=>{try{let t=await o.getWalletById(s.params.id);if(!t)return e.status(404).json({message:"Wallet not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});d.post("/api/wallets",I,async(s,e)=>{try{let t=te.parse({...s.body,userId:s.userId}),a=await o.createWallet(t);e.status(201).json(a)}catch(t){if(t instanceof A.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});d.put("/api/wallets/:id",I,async(s,e)=>{try{let t=await o.getWalletById(s.params.id);if(!t)return e.status(404).json({message:"Wallet not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});let a=te.partial().parse(s.body),r=await o.updateWallet(s.params.id,a);e.json(r)}catch(t){if(t instanceof A.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});d.delete("/api/wallets/:id",I,async(s,e)=>{try{let t=await o.getWalletById(s.params.id);if(!t)return e.status(404).json({message:"Wallet not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});await o.deleteWallet(s.params.id),e.status(204).send()}catch{e.status(500).json({message:"Internal server error"})}});d.get("/api/qr-codes",I,async(s,e)=>{try{let t=await o.getQrCodes(s.userId);e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});d.get("/api/qr-codes/:id",I,async(s,e)=>{try{let t=await o.getQrCodeById(s.params.id);if(!t)return e.status(404).json({message:"QR code not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});d.post("/api/qr-codes",I,async(s,e)=>{try{let t=se.parse({...s.body,userId:s.userId}),a=await o.createQrCode(t);e.status(201).json(a)}catch(t){if(t instanceof A.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});d.put("/api/qr-codes/:id",I,async(s,e)=>{try{let t=await o.getQrCodeById(s.params.id);if(!t)return e.status(404).json({message:"QR code not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});let a=se.partial().parse(s.body),r=await o.updateQrCode(s.params.id,a);e.json(r)}catch(t){if(t instanceof A.ZodError)return e.status(400).json({message:"Validation error",errors:t.errors});e.status(500).json({message:"Internal server error"})}});d.delete("/api/qr-codes/:id",I,async(s,e)=>{try{let t=await o.getQrCodeById(s.params.id);if(!t)return e.status(404).json({message:"QR code not found"});if(t.userId!==s.userId)return e.status(403).json({message:"Forbidden"});await o.deleteQrCode(s.params.id),e.status(204).send()}catch{e.status(500).json({message:"Internal server error"})}});d.get("/api/api-keys",I,async(s,e)=>{try{let t=await o.getApiKeys(s.userId);e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});d.post("/api/api-keys",I,async(s,e)=>{try{let{mode:t}=s.body;if(!t||t!=="sandbox"&&t!=="live")return e.status(400).json({message:"Mode must be 'sandbox' or 'live'"});let r=(t==="sandbox"?"sk_sandbox_":"sk_live_")+At.randomBytes(24).toString("hex"),n=await o.createOrResetApiKey(s.userId,t,r);e.status(201).json(n)}catch{e.status(500).json({message:"Internal server error"})}});d.patch("/api/api-keys/:id/status",I,async(s,e)=>{try{if(!(await o.getApiKeys(s.userId)).find(i=>i.id===s.params.id))return e.status(404).json({message:"API key not found"});let{isActive:r}=s.body;if(typeof r!="boolean")return e.status(400).json({message:"isActive must be a boolean"});let n=await o.updateApiKeyStatus(s.params.id,r);e.json(n)}catch{e.status(500).json({message:"Internal server error"})}});d.get("/api/analytics/stats",I,async(s,e)=>{try{let t=await o.getTransactionStats(s.userId);e.json(t)}catch{e.status(500).json({message:"Internal server error"})}});d.get("/api/analytics/revenue",I,async(s,e)=>{try{let t=s.query.startDate?new Date(s.query.startDate):void 0,a=s.query.endDate?new Date(s.query.endDate):void 0,r=await o.getRevenueStats(s.userId,t,a);e.json(r)}catch{e.status(500).json({message:"Internal server error"})}});var Rt=A.object({external_id:A.string().min(1).max(100),amount:A.number().int().positive().min(1e3).max(1e8),payment_method:A.enum(["QRIS","BCAVA","BRIVA","BNIVA","GOPAY","DANA","OVO"]).default("QRIS"),description:A.string().max(255).optional(),customer_name:A.string().max(100).optional(),customer_email:A.string().email().optional(),customer_phone:A.string().max(20).optional(),callback_url:A.string().url().optional(),expiry_minutes:A.number().int().positive().min(5).max(1440).default(30)});d.post("/api/v1/payments",$,X,async(s,e)=>{try{let t=Rt.parse(s.body),a=s.headers["x-idempotency-key"];if(a){let f=await o.getPaymentByIdempotencyKey(a);if(f)return e.status(200).json({success:!0,data:{id:f.id,external_id:f.externalId,amount:f.amount,description:f.description,customer_name:f.customerName,customer_email:f.customerEmail,status:f.status,payment_method:f.paymentMethod,qr_string:f.qrString,qr_url:f.qrUrl,expires_at:f.expiresAt,created_at:f.createdAt},meta:{idempotent:!0,sandbox_mode:!C}})}await o.getPaymentChannelByCode(t.payment_method)||await o.seedPaymentChannels();let n=await o.getPaymentChannelByCode(t.payment_method),i=n?.feePercentage||.7,g=n?.feeFlat||0,p=Math.ceil(t.amount*i/100+g),l=t.amount-p,y=new Date(Date.now()+t.expiry_minutes*60*1e3),b="",H="",j="";if(C&&O)try{let f=await O.createTransaction({method:t.payment_method,merchant_ref:t.external_id,amount:t.amount,customer_name:t.customer_name,customer_email:t.customer_email,customer_phone:t.customer_phone,expired_time:t.expiry_minutes,callback_url:t.callback_url});b=f.data.qr_string||"",H=f.data.qr_url||"",j=f.data.reference||"",console.log("[Payment] QRIS created via Sakurupiah",{externalId:t.external_id,providerRef:j})}catch(f){console.error("[Payment] Sakurupiah error, falling back to sandbox:",f),b=Te(t.external_id,t.amount,t.customer_name),H=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(b)}`}else b=Te(t.external_id,t.amount,t.customer_name),H=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(b)}`;let _=await o.createPayment({userId:s.apiKeyUserId,externalId:t.external_id,amount:t.amount,status:"pending",feeAmount:p,netAmount:l,description:t.description||null,customerName:t.customer_name||null,customerEmail:t.customer_email||null,customerPhone:t.customer_phone||null,paymentMethod:t.payment_method,qrString:b,qrUrl:H,callbackUrl:t.callback_url||null,expiresAt:y,idempotencyKey:a||null,providerRef:j||null,providerStatus:null});e.status(201).json({success:!0,data:{id:_.id,external_id:_.externalId,amount:_.amount,fee_amount:_.feeAmount,net_amount:_.netAmount,description:_.description,customer_name:_.customerName,customer_email:_.customerEmail,status:_.status,payment_method:_.paymentMethod,qr_string:_.qrString,qr_url:_.qrUrl,expires_at:_.expiresAt,created_at:_.createdAt},meta:{sandbox_mode:!C}})}catch(t){if(t instanceof A.ZodError)return e.status(400).json({success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid request body",details:t.errors}});console.error("Create payment error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});d.get("/api/v1/payments",$,X,async(s,e)=>{try{let t=s.query.limit?parseInt(s.query.limit):100,a=await o.getPayments(s.apiKeyUserId,t);e.json({success:!0,data:a.map(r=>({id:r.id,external_id:r.externalId,amount:r.amount,fee_amount:r.feeAmount,net_amount:r.netAmount,description:r.description,customer_name:r.customerName,status:r.status,payment_method:r.paymentMethod,expires_at:r.expiresAt,paid_at:r.paidAt,created_at:r.createdAt})),meta:{count:a.length,limit:t,sandbox_mode:!C}})}catch(t){console.error("Get payments error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});d.get("/api/v1/payments/:id",$,X,async(s,e)=>{try{let t=await o.getPaymentById(s.params.id);if(t||(t=await o.getPaymentByExternalId(s.params.id)),!t)return e.status(404).json({success:!1,error:{code:"PAYMENT_NOT_FOUND",message:"Payment not found"}});if(t.userId!==s.apiKeyUserId)return e.status(403).json({success:!1,error:{code:"FORBIDDEN",message:"You don't have permission to access this payment"}});e.json({success:!0,data:{id:t.id,external_id:t.externalId,amount:t.amount,fee_amount:t.feeAmount,net_amount:t.netAmount,description:t.description,customer_name:t.customerName,customer_email:t.customerEmail,customer_phone:t.customerPhone,status:t.status,payment_method:t.paymentMethod,qr_string:t.qrString,qr_url:t.qrUrl,expires_at:t.expiresAt,paid_at:t.paidAt,created_at:t.createdAt},meta:{sandbox_mode:!C}})}catch(t){console.error("Get payment error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});var xt=A.object({status:A.enum(["paid","expired","failed"])});d.post("/api/v1/payments/:id/simulate",$,X,async(s,e)=>{try{if(s.apiKey?.mode!=="sandbox")return e.status(403).json({success:!1,error:{code:"SANDBOX_ONLY",message:"Payment simulation is only available in sandbox mode. Use a sandbox API key."}});let t=xt.parse(s.body),a=await o.getPaymentById(s.params.id);if(a||(a=await o.getPaymentByExternalId(s.params.id)),!a)return e.status(404).json({success:!1,error:{code:"PAYMENT_NOT_FOUND",message:"Payment not found"}});if(a.userId!==s.apiKeyUserId)return e.status(403).json({success:!1,error:{code:"FORBIDDEN",message:"You don't have permission to access this payment"}});if(a.status!=="pending")return e.status(400).json({success:!1,error:{code:"INVALID_STATUS",message:`Cannot simulate payment. Current status is '${a.status}'. Only pending payments can be simulated.`}});let r={status:t.status};t.status==="paid"&&(r.paidAt=new Date);let n=await o.updatePayment(a.id,r);e.json({success:!0,data:{id:n.id,external_id:n.externalId,amount:n.amount,description:n.description,customer_name:n.customerName,customer_email:n.customerEmail,status:n.status,qr_string:n.qrString,expires_at:n.expiresAt,paid_at:n.paidAt||null,created_at:n.createdAt},message:`Payment status updated to '${t.status}'`})}catch(t){if(t instanceof A.ZodError)return e.status(400).json({success:!1,error:{code:"VALIDATION_ERROR",message:"Invalid request body",details:t.errors}});console.error("Simulate payment error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});d.get("/api/v1/payments/:id/status",$,X,async(s,e)=>{try{let t=await o.getPaymentById(s.params.id);if(t||(t=await o.getPaymentByExternalId(s.params.id)),!t)return e.status(404).json({success:!1,error:{code:"PAYMENT_NOT_FOUND",message:"Payment not found"}});if(t.userId!==s.apiKeyUserId)return e.status(403).json({success:!1,error:{code:"FORBIDDEN",message:"You don't have permission to access this payment"}});let a=t.status,r=t.paidAt,n=t.providerStatus;if(C&&O&&t.providerRef&&t.status==="pending")try{let i=await O.checkTransactionStatus(t.providerRef);n=i.data.status;let p={PAID:"paid",SUCCESS:"paid",EXPIRED:"expired",FAILED:"failed",CANCELLED:"cancelled",PENDING:"pending"}[i.data.status.toUpperCase()]||t.status;if(p!==t.status){let l={status:p,providerStatus:i.data.status};p==="paid"&&i.data.paid_at&&(l.paidAt=new Date(i.data.paid_at),r=new Date(i.data.paid_at)),await o.updatePayment(t.id,l),a=p,console.log("[Payment] Status updated from Sakurupiah",{paymentId:t.id,oldStatus:t.status,newStatus:p})}}catch(i){console.error("[Payment] Failed to check status from Sakurupiah:",i)}else{let i=t.status==="pending"&&new Date>new Date(t.expiresAt);a=i?"expired":t.status,i&&t.status==="pending"&&await o.updatePayment(t.id,{status:"expired"})}e.json({success:!0,data:{id:t.id,external_id:t.externalId,status:a,provider_status:n,amount:t.amount,fee_amount:t.feeAmount,net_amount:t.netAmount,paid_at:r||null}})}catch(t){console.error("Get payment status error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});d.post("/api/v1/webhooks/sakurupiah",bt,le,async(s,e)=>{try{await q();let t=s.headers["x-signature"]||s.headers["x-sakurupiah-signature"],a=JSON.stringify(s.body);await o.createWebhookLog({paymentId:s.body?.reference||"unknown",eventType:s.body?.status||"unknown",payload:a,signature:t||"",verified:!1,createdAt:new Date}),(!C||!O)&&console.warn("[Webhook] Sakurupiah not configured, processing webhook in sandbox mode");let r=!0;if(C&&O&&t&&(r=O.verifyWebhookSignature(a,t),!r))return console.warn("[Webhook] Invalid signature received"),e.status(401).json({success:!1,error:{code:"INVALID_SIGNATURE",message:"Webhook signature verification failed"}});let{reference:n,merchant_ref:i,status:g,amount:p,paid_at:l}=s.body;if(!n&&!i)return e.status(400).json({success:!1,error:{code:"INVALID_PAYLOAD",message:"Missing reference or merchant_ref in webhook payload"}});let y=await o.getPayments("",1e3),b=y.find(f=>f.providerRef===n);if(!b&&i&&(b=y.find(f=>f.externalId===i||f.id.includes(i))),!b)return console.warn("[Webhook] Payment not found for reference:",n),e.status(404).json({success:!1,error:{code:"PAYMENT_NOT_FOUND",message:"Payment not found for this webhook"}});let j={PAID:"paid",SUCCESS:"paid",EXPIRED:"expired",FAILED:"failed",CANCELLED:"cancelled",PENDING:"pending"}[g?.toUpperCase()]||g?.toLowerCase()||b.status,_={status:j,providerStatus:g};j==="paid"&&l?_.paidAt=new Date(l):j==="paid"&&!b.paidAt&&(_.paidAt=new Date),await o.updatePayment(b.id,_),await o.createWebhookLog({paymentId:b.id,eventType:`payment.${j}`,payload:a,signature:t||"",verified:r,createdAt:new Date}),console.log("[Webhook] Payment status updated",{paymentId:b.id,oldStatus:b.status,newStatus:j,reference:n}),e.status(200).json({success:!0,message:"Webhook processed successfully"})}catch(t){console.error("[Webhook] Error processing webhook:",t),e.status(500).json({success:!1,error:{code:"WEBHOOK_PROCESSING_ERROR",message:"Failed to process webhook"}})}});d.get("/api/v1/payment-channels",$,le,async(s,e)=>{try{await q();let a=(await o.getPaymentChannels()).filter(r=>r.isActive);e.json({success:!0,data:a.map(r=>({code:r.code,name:r.name,type:r.type,fee_percentage:r.feePercentage,fee_flat:r.feeFlat,min_amount:r.minAmount,max_amount:r.maxAmount,icon_url:r.iconUrl})),meta:{count:a.length,sandbox_mode:!C}})}catch(t){console.error("Get payment channels error:",t),e.status(500).json({success:!1,error:{code:"INTERNAL_ERROR",message:"Internal server error"}})}});d.use((s,e,t,a)=>{let r=s.status||s.statusCode||500,n=s.message||"Internal Server Error";t.status(r).json({message:n})});var Yt=ht(d);export{Yt as default};
